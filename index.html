  <!DOCTYPE html>
  <html lang="es">
  <head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GESTIUM ¬∑ Premium ¬∑ Inteligencia Operativa</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <style>
  :root{
    --navy:    #070d1a;
    --navy2:   #0d1629;
    --navy3:   #111e35;
    --navy4:   #1a2a45;
    --orange:  #f97316;
    --orange2: #fb923c;
    --orange3: #fdba74;
    --teal:    #06d6c8;
    --teal2:   #22d3ee;
    --teal3:   #67e8f9;
    --text:    #e2e8f0;
    --text2:   #94a3b8;
    --text3:   #64748b;
    --white:   #ffffff;
    --red:     #ef4444;
    --amber:   #f59e0b;
    --green:   #10b981;
    --r:       10px;
    --r2:      16px;
    --shadow:  0 4px 24px rgba(0,0,0,.4);
    --shadow2: 0 8px 40px rgba(0,0,0,.5);
  }
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  html{font-size:15px;scroll-behavior:smooth}
  body{font-family:'Syne',system-ui,sans-serif;background:var(--navy);color:var(--text);-webkit-font-smoothing:antialiased;min-height:100vh}

  /* ‚îÄ‚îÄ WATERMARK GLOBAL ‚îÄ‚îÄ */
  body::after{
    content:'GESTIUM';
    position:fixed;bottom:50%;right:-60px;
    font-size:110px;font-weight:800;letter-spacing:8px;
    color:rgba(249,115,22,.03);
    transform:rotate(-90deg) translateY(50%);
    pointer-events:none;z-index:0;white-space:nowrap;
    font-family:'Syne',sans-serif;
  }

  /* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
  #loginScreen{
    display:flex;min-height:100vh;
    background:var(--navy);overflow:hidden;position:relative;
  }
  /* Gradiente animado */
  #loginScreen::before{
    content:'';position:absolute;inset:0;
    background:
      radial-gradient(ellipse at 15% 50%, rgba(6,214,200,.12) 0%, transparent 55%),
      radial-gradient(ellipse at 85% 20%, rgba(249,115,22,.14) 0%, transparent 50%),
      radial-gradient(ellipse at 60% 80%, rgba(6,214,200,.06) 0%, transparent 45%);
    pointer-events:none;
    animation: gradientShift 8s ease infinite;
  }
  @keyframes gradientShift{
    0%,100%{opacity:1;transform:translateX(0)}
    50%{opacity:.8;transform:translateX(20px) translateY(-15px)}
  }
  .login-grid-bg{
    position:absolute;inset:0;
    background-image:
      linear-gradient(rgba(6,214,200,.04) 1px, transparent 1px),
      linear-gradient(90deg, rgba(6,214,200,.04) 1px, transparent 1px);
    background-size:60px 60px;
    pointer-events:none;
    animation: gridPulse 4s ease infinite;
  }
  @keyframes gridPulse{
    0%,100%{opacity:.4}
    50%{opacity:.2}
  }
  .login-deco{
    flex:1;display:flex;flex-direction:column;justify-content:center;
    padding:72px;position:relative;z-index:1;
  }
  .login-hex-decor{
    position:absolute;right:-80px;top:50%;transform:translateY(-50%);
    width:400px;height:400px;opacity:.06;
    background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpolygon points='50,2 95,26 95,74 50,98 5,74 5,26' fill='%23f97316' stroke='%2306d6c8' stroke-width='2'/%3E%3C/svg%3E") center/contain no-repeat;
    animation: hexFloat 6s ease-in-out infinite;
  }
  @keyframes hexFloat{
    0%,100%{transform:translateY(-50%) rotate(0deg)}
    50%{transform:translateY(-55%) rotate(5deg)}
  }
  .login-eyebrow{
    font-size:10px;font-weight:700;letter-spacing:4px;text-transform:uppercase;
    color:var(--teal);margin-bottom:22px;
    display:flex;align-items:center;gap:10px;
  }
  .login-eyebrow::before{content:'';width:32px;height:2px;background:var(--teal);animation:lineGrow 2s ease infinite}
  @keyframes lineGrow{
    0%,100%{width:32px}
    50%{width:48px}
  }
  .login-headline{
    font-size:clamp(32px,4vw,56px);font-weight:800;line-height:1.05;
    color:var(--white);margin-bottom:20px;letter-spacing:-1px;
  }
  .login-headline em{
    color:var(--orange);font-style:normal;
    text-shadow:0 0 40px rgba(249,115,22,.4);
    animation: textGlow 3s ease infinite;
  }
  @keyframes textGlow{
    0%,100%{text-shadow:0 0 40px rgba(249,115,22,.4)}
    50%{text-shadow:0 0 50px rgba(249,115,22,.6)}
  }
  .login-tagline{font-size:15px;color:var(--text2);line-height:1.7;max-width:380px}
  .login-chips{display:flex;gap:10px;flex-wrap:wrap;margin-top:48px}
  .login-chip{
    padding:10px 18px;border-radius:100px;
    border:1px solid rgba(6,214,200,.2);
    color:var(--teal3);font-size:12px;font-weight:600;letter-spacing:.5px;
    background:rgba(6,214,200,.05);
    cursor:pointer;
    transition:all .25s ease;
    position:relative;
  }
  .login-chip:hover{
    background:rgba(6,214,200,.12);
    border-color:rgba(6,214,200,.4);
    transform:translateY(-2px);
    box-shadow:0 4px 16px rgba(6,214,200,.2);
  }
  .login-chip:active{transform:translateY(0)}

  .login-panel{
    width:440px;min-height:100vh;
    background:var(--navy2);
    display:flex;flex-direction:column;justify-content:center;
    padding:60px 48px;position:relative;z-index:1;
    border-left:1px solid rgba(6,214,200,.08);
  }
  .login-panel::before{
    content:'';position:absolute;top:0;left:0;right:0;height:3px;
    background:linear-gradient(90deg,var(--teal),var(--orange));
  }
  .login-logo-text{
    font-size:22px;font-weight:800;color:var(--white);
    letter-spacing:2px;margin-bottom:4px;
  }
  .login-logo-text span{color:var(--orange)}
  .login-sub-text{
    font-size:11px;color:var(--teal);letter-spacing:2px;
    text-transform:uppercase;font-weight:600;margin-bottom:36px;
  }
  .f-label{
    display:block;font-size:10px;font-weight:700;letter-spacing:1px;
    text-transform:uppercase;color:var(--text3);margin-bottom:7px;
  }
  .f-input{
    width:100%;padding:12px 16px;
    border-radius:var(--r);
    border:1.5px solid rgba(255,255,255,.08);
    background:rgba(255,255,255,.04);
    font-family:inherit;font-size:14px;color:var(--text);
    outline:none;transition:border-color .2s,box-shadow .2s;
  }
  .f-input:focus{border-color:var(--teal);box-shadow:0 0 0 3px rgba(6,214,200,.12)}
  .f-input::placeholder{color:var(--text3)}
  .pw-wrap{position:relative}.pw-wrap .f-input{padding-right:44px}
  .pw-eye{position:absolute;right:14px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:14px;opacity:.4;transition:opacity .2s}
  .pw-eye:hover{opacity:1}
  .login-row{display:flex;justify-content:space-between;align-items:center;margin:12px 0 22px}
  .rem-label{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text2);cursor:pointer}
  .rem-label input{accent-color:var(--teal);width:14px;height:14px}
  .btn{
    display:inline-flex;align-items:center;justify-content:center;gap:8px;
    cursor:pointer;border:none;font-family:inherit;font-size:14px;font-weight:700;
    border-radius:var(--r);padding:13px 22px;
    transition:transform .14s,box-shadow .14s,opacity .14s;letter-spacing:.3px;
  }
  .btn:active{transform:scale(.97)}
  .btn-primary{
    background:linear-gradient(135deg,var(--teal),var(--orange));
    color:#fff;box-shadow:0 4px 20px rgba(249,115,22,.25);width:100%;
  }
  .btn-primary:hover{box-shadow:0 6px 30px rgba(249,115,22,.4)}
  .btn-ghost{background:none;color:var(--teal);font-size:12px;padding:5px 0;font-weight:600}
  .btn-sm{padding:8px 16px;font-size:12px;border-radius:8px}
  .btn-navy{background:var(--navy4);color:var(--text);border:1px solid rgba(255,255,255,.08)}
  .btn-orange{background:rgba(249,115,22,.15);color:var(--orange);border:1px solid rgba(249,115,22,.2)}
  .btn-teal{background:rgba(6,214,200,.12);color:var(--teal);border:1px solid rgba(6,214,200,.2)}
  .btn-danger{background:rgba(239,68,68,.12);color:var(--red);border:1px solid rgba(239,68,68,.2)}
  .btn-whatsapp{background:#25d366;color:#fff;border:none}
  .btn-whatsapp:hover{background:#20ba5a}
  .login-msg{min-height:18px;font-size:12px;color:var(--red);text-align:center;margin-top:12px}
  .login-footer{text-align:center;margin-top:24px;font-size:12px;color:var(--text3)}
  @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
  .shake{animation:shake .3s ease}
  .input-error{border-color:var(--red)!important;box-shadow:0 0 0 3px rgba(239,68,68,.1)!important}

  /* ‚îÄ‚îÄ CONTACTO LOGIN ‚îÄ‚îÄ */
  .login-contact{
    display:flex;gap:10px;margin-top:32px;flex-wrap:wrap;
  }
  .contact-btn{
    flex:1;min-width:140px;
    padding:10px 14px;border-radius:var(--r);
    font-size:11px;font-weight:700;letter-spacing:.5px;
    text-decoration:none;text-align:center;
    transition:all .2s;display:flex;align-items:center;justify-content:center;gap:6px;
  }
  .contact-btn.whats{background:#25d366;color:#fff}
  .contact-btn.whats:hover{background:#20ba5a;transform:translateY(-2px)}
  .contact-btn.email{background:rgba(249,115,22,.12);color:var(--orange);border:1px solid rgba(249,115,22,.2)}
  .contact-btn.email:hover{background:rgba(249,115,22,.2);transform:translateY(-2px)}

  /* ‚îÄ‚îÄ MODAL EXPLICATIVO CHIPS ‚îÄ‚îÄ */
  .chip-modal{
    display:none;position:fixed;inset:0;
    background:rgba(0,0,0,.7);backdrop-filter:blur(6px);
    z-index:9999;align-items:center;justify-content:center;
    padding:20px;
  }
  .chip-modal.show{display:flex}
  .chip-modal-content{
    background:var(--navy2);border-radius:var(--r2);
    border:1px solid rgba(6,214,200,.2);
    max-width:480px;width:100%;
    padding:32px;position:relative;
    box-shadow:0 16px 64px rgba(0,0,0,.6);
    animation:modalPop .3s ease;
  }
  @keyframes modalPop{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}
  .chip-modal-close{
    position:absolute;top:16px;right:16px;
    background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.2);
    color:var(--red);width:32px;height:32px;border-radius:50%;
    cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;
    transition:all .2s;
  }
  .chip-modal-close:hover{background:rgba(239,68,68,.2);transform:rotate(90deg)}
  .chip-modal-icon{font-size:48px;margin-bottom:16px}
  .chip-modal-title{font-size:20px;font-weight:800;color:var(--white);margin-bottom:12px;letter-spacing:-.3px}
  .chip-modal-desc{font-size:14px;color:var(--text2);line-height:1.65;margin-bottom:20px}
  .chip-modal-list{list-style:none;padding:0}
  .chip-modal-list li{
    padding:8px 0;padding-left:24px;position:relative;
    font-size:13px;color:var(--text);line-height:1.5;
  }
  .chip-modal-list li::before{
    content:'‚úì';position:absolute;left:0;
    color:var(--teal);font-weight:700;
  }

  @media(max-width:800px){.login-deco{display:none}.login-panel{width:100%;padding:40px 24px}}

  /* ‚îÄ‚îÄ REGISTRO (igual) ‚îÄ‚îÄ */
  #registerScreen{
    display:none;min-height:100vh;background:var(--navy);
    align-items:flex-start;justify-content:center;
    padding:48px 20px;overflow-y:auto;position:relative;
  }
  #registerScreen::before{
    content:'';position:absolute;inset:0;
    background:radial-gradient(ellipse at 30% 40%, rgba(6,214,200,.08) 0%, transparent 50%),
              radial-gradient(ellipse at 70% 70%, rgba(249,115,22,.08) 0%, transparent 50%);
    pointer-events:none;
  }
  .reg-card{
    width:560px;max-width:100%;background:var(--navy2);
    border-radius:var(--r2);box-shadow:var(--shadow2);
    border:1px solid rgba(6,214,200,.1);overflow:hidden;position:relative;z-index:1;
  }
  @keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
  .fade-up{animation:fadeUp .35s ease both}
  .reg-head{
    background:linear-gradient(135deg,var(--navy3),var(--navy4));
    padding:32px 40px 28px;border-bottom:1px solid rgba(6,214,200,.1);position:relative;overflow:hidden;
  }
  .reg-head::after{
    content:'';position:absolute;top:-30px;right:-30px;
    width:120px;height:120px;border-radius:50%;
    background:radial-gradient(circle,rgba(249,115,22,.15),transparent);
  }
  .reg-head::before{
    content:'';position:absolute;bottom:-20px;left:-20px;
    width:80px;height:80px;border-radius:50%;
    background:radial-gradient(circle,rgba(6,214,200,.1),transparent);
  }
  .reg-head h2{font-size:22px;font-weight:800;color:var(--white);margin-bottom:4px;position:relative;z-index:1}
  .reg-head p{font-size:12px;color:var(--text3);position:relative;z-index:1}
  .reg-body{padding:30px 40px 40px}
  .reg-sep{
    display:flex;align-items:center;gap:10px;font-size:10px;font-weight:700;
    letter-spacing:1.5px;text-transform:uppercase;color:var(--teal);margin:24px 0 14px;
  }
  .reg-sep::before,.reg-sep::after{content:'';flex:1;height:1px;background:rgba(6,214,200,.15)}
  .reg-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media(max-width:500px){.reg-2{grid-template-columns:1fr}}
  .ri{
    width:100%;padding:11px 14px;border-radius:8px;
    border:1.5px solid rgba(255,255,255,.07);background:rgba(255,255,255,.03);
    font-family:inherit;font-size:13px;color:var(--text);
    outline:none;transition:border-color .2s,box-shadow .2s;margin-bottom:8px;
  }
  .ri::placeholder{color:var(--text3)}
  .ri:focus{border-color:var(--teal);box-shadow:0 0 0 3px rgba(6,214,200,.1)}
  .reg-msg{min-height:18px;font-size:12px;color:var(--red);text-align:center;margin-top:8px}
  .mode-tgl{
    display:flex;border-radius:8px;overflow:hidden;
    border:1.5px solid rgba(255,255,255,.08);margin-bottom:20px;
  }
  .mode-btn{
    flex:1;padding:10px 14px;background:transparent;border:none;
    font-family:inherit;font-size:12px;font-weight:700;
    color:var(--text3);cursor:pointer;transition:background .15s,color .15s;letter-spacing:.3px;
  }
  .mode-btn.on{background:var(--navy4);color:var(--teal)}

  /* ‚îÄ‚îÄ APP ‚îÄ‚îÄ */
  #app{display:none}
  .sidebar{
    position:fixed;left:0;top:0;width:256px;height:100vh;
    background:var(--navy2);
    display:flex;flex-direction:column;z-index:200;
    border-right:1px solid rgba(6,214,200,.06);
  }
  .sb-stripe{height:3px;background:linear-gradient(90deg,var(--teal),var(--orange))}
  .sb-top{padding:24px 20px 16px;border-bottom:1px solid rgba(255,255,255,.04)}
  .sb-brand{
    font-size:9px;font-weight:700;letter-spacing:3px;text-transform:uppercase;
    color:var(--teal);margin-bottom:8px;display:flex;align-items:center;gap:8px;
  }
  .sb-brand::before{content:'';width:20px;height:1px;background:var(--teal)}
  .sb-company{font-size:15px;font-weight:800;color:var(--white);word-break:break-word;line-height:1.3}
  .sb-nav{flex:1;padding:16px 10px;display:flex;flex-direction:column;gap:2px;overflow-y:auto}
  .sb-section{
    font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;
    color:var(--text3);padding:12px 12px 6px;
  }
  .sb-item{
    display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;
    background:none;border:none;color:var(--text2);
    font-family:inherit;font-size:13px;font-weight:600;
    cursor:pointer;text-align:left;transition:background .15s,color .15s;width:100%;
  }
  .sb-item:hover{background:rgba(255,255,255,.04);color:var(--text)}
  .sb-item.active{background:rgba(6,214,200,.08);color:var(--teal);border:none}
  .sb-item.active .sb-dot{background:var(--teal)}
  .sb-dot{width:6px;height:6px;border-radius:50%;background:var(--text3);flex-shrink:0;transition:background .15s}
  .sb-footer{padding:16px 10px;border-top:1px solid rgba(255,255,255,.04)}
  .user-pill{
    display:flex;align-items:center;gap:10px;padding:12px;
    border-radius:10px;background:rgba(255,255,255,.03);
    border:1px solid rgba(255,255,255,.05);margin-bottom:10px;
  }
  .user-av{
    width:36px;height:36px;border-radius:8px;
    background:linear-gradient(135deg,var(--teal),var(--orange));
    display:flex;align-items:center;justify-content:center;
    font-size:14px;font-weight:800;color:#fff;flex-shrink:0;
  }
  .user-info{min-width:0}
  .user-name{font-size:12px;font-weight:700;color:var(--white);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .user-email{font-size:10px;color:var(--text3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .btn-logout{
    width:100%;padding:10px;border-radius:8px;background:none;
    border:1px solid rgba(239,68,68,.15);color:rgba(239,68,68,.6);
    font-family:inherit;font-size:12px;font-weight:700;cursor:pointer;
    display:flex;align-items:center;justify-content:center;gap:7px;
    transition:background .15s,color .15s;
  }
  .btn-logout:hover{background:rgba(239,68,68,.08);color:var(--red)}

  /* ‚îÄ‚îÄ SIDEBAR CONTACTO ‚îÄ‚îÄ */
  .sb-contact{
    margin-bottom:10px;padding:12px;
    border-radius:10px;background:rgba(6,214,200,.04);
    border:1px solid rgba(6,214,200,.1);
  }
  .sb-contact-title{
    font-size:9px;font-weight:700;letter-spacing:1.5px;
    text-transform:uppercase;color:var(--teal);margin-bottom:10px;
  }
  .sb-contact-btns{display:flex;flex-direction:column;gap:6px}
  .sb-contact-btn{
    padding:8px 12px;border-radius:8px;
    font-size:11px;font-weight:600;
    text-decoration:none;text-align:center;
    transition:all .2s;display:flex;align-items:center;gap:6px;
  }
  .sb-contact-btn.whats{background:#25d366;color:#fff}
  .sb-contact-btn.whats:hover{background:#20ba5a;transform:translateX(2px)}
  .sb-contact-btn.email{background:rgba(249,115,22,.12);color:var(--orange);border:1px solid rgba(249,115,22,.2)}
  .sb-contact-btn.email:hover{background:rgba(249,115,22,.2);transform:translateX(2px)}

  .main{margin-left:256px;min-height:100vh;background:var(--navy)}
  .topbar{
    background:var(--navy2);
    border-bottom:1px solid rgba(6,214,200,.06);
    padding:0 36px;height:62px;
    display:flex;align-items:center;justify-content:space-between;
    position:sticky;top:0;z-index:100;
  }
  .topbar-title{font-size:15px;font-weight:800;color:var(--white);letter-spacing:.5px}
  .topbar-badge{
    font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;
    color:var(--teal);background:rgba(6,214,200,.1);
    padding:3px 10px;border-radius:100px;border:1px solid rgba(6,214,200,.2);
  }
  #menuToggle{display:none;background:none;border:none;cursor:pointer;color:var(--text);font-size:20px;padding:4px 8px;margin-right:10px}
  .page{padding:32px 36px}

  /* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
  .card{
    background:var(--navy2);border-radius:var(--r2);
    border:1px solid rgba(255,255,255,.05);
    box-shadow:0 2px 16px rgba(0,0,0,.3);
  }
  .card-body{padding:24px}
  .card-title{
    font-size:14px;font-weight:700;color:var(--text);
    margin-bottom:16px;display:flex;align-items:center;gap:8px;letter-spacing:.3px;
  }
  .card-title-accent{color:var(--orange);font-size:12px;font-weight:600}

  /* ‚îÄ‚îÄ KPI ‚îÄ‚îÄ */
  .kpi-row{display:flex;gap:14px;margin-bottom:24px;flex-wrap:wrap}
  .kpi{
    flex:1;min-width:150px;
    background:var(--navy2);border-radius:var(--r2);
    padding:18px 20px;border:1px solid rgba(255,255,255,.05);
    position:relative;overflow:hidden;
    transition:transform .2s,border-color .2s;
  }
  .kpi:hover{transform:translateY(-2px);border-color:rgba(6,214,200,.15)}
  .kpi::before{
    content:'';position:absolute;left:0;top:0;bottom:0;width:3px;border-radius:3px 0 0 3px;
  }
  .kpi.k-teal::before{background:var(--teal)}
  .kpi.k-orange::before{background:var(--orange)}
  .kpi.k-amber::before{background:var(--amber)}
  .kpi.k-green::before{background:var(--green)}
  .kpi.k-gray::before{background:var(--text3)}
  .kpi-lbl{
    font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;
    color:var(--text3);margin-bottom:6px;
  }
  .kpi-val{
    font-size:18px;font-weight:700;color:var(--white);
    font-family:'JetBrains Mono',monospace;
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  }
  .kpi-val.pos{color:var(--teal)}
  .kpi-val.neg{color:var(--red)}

  /* ‚îÄ‚îÄ CHARTS ‚îÄ‚îÄ */
  .charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}
  .chart-box{
    background:var(--navy2);border-radius:var(--r2);
    border:1px solid rgba(255,255,255,.05);
    padding:22px;position:relative;overflow:hidden;
  }
  .chart-box-full{grid-column:1/-1}
  .chart-label{
    font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;
    color:var(--text3);margin-bottom:18px;
    display:flex;align-items:center;gap:10px;
  }
  .chart-label span{color:var(--teal)}
  .chart-label::after{content:'';flex:1;height:1px;background:rgba(255,255,255,.05)}
  .chart-container{position:relative;width:100%}
  @media(max-width:900px){.charts-grid{grid-template-columns:1fr}.chart-box-full{grid-column:auto}}

  /* ‚îÄ‚îÄ TABLA ‚îÄ‚îÄ */
  .tbl-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
  table{width:100%;border-collapse:collapse;min-width:580px}
  thead{background:rgba(6,214,200,.04);border-bottom:1px solid rgba(6,214,200,.1)}
  th{
    padding:12px 16px;text-align:left;font-size:9px;font-weight:700;
    letter-spacing:1px;text-transform:uppercase;color:var(--teal);white-space:nowrap;
  }
  td{padding:12px 16px;font-size:13px;border-bottom:1px solid rgba(255,255,255,.04);color:var(--text)}
  tr:hover td{background:rgba(255,255,255,.02)}

  /* ‚îÄ‚îÄ FORM ‚îÄ‚îÄ */
  .f-lbl{
    display:block;font-size:10px;font-weight:700;letter-spacing:.8px;
    text-transform:uppercase;color:var(--text3);margin-bottom:7px;
  }
  .inp{
    width:100%;padding:11px 14px;border-radius:var(--r);
    border:1.5px solid rgba(255,255,255,.07);
    background:rgba(255,255,255,.03);
    font-family:inherit;font-size:13px;color:var(--text);
    outline:none;transition:border-color .2s,box-shadow .2s;
  }
    select.inp{
      background: var(--navy3);
      color: var(--white);
      border: 1.5px solid rgba(6,214,200,.15);
    }
  .inp::placeholder{color:var(--text3)}
  .inp:focus{border-color:var(--teal);box-shadow:0 0 0 3px rgba(6,214,200,.08)}
  .inp-row{display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end}

  /* ‚îÄ‚îÄ BADGE ‚îÄ‚îÄ */
  .badge{
    display:inline-flex;align-items:center;gap:5px;
    padding:4px 12px;border-radius:100px;font-size:10px;font-weight:700;letter-spacing:.5px;
  }
  .badge-teal{background:rgba(6,214,200,.12);color:var(--teal);border:1px solid rgba(6,214,200,.2)}
  .badge-amber{background:rgba(245,158,11,.1);color:var(--amber);border:1px solid rgba(245,158,11,.2)}
  .badge-red{background:rgba(239,68,68,.1);color:var(--red);border:1px solid rgba(239,68,68,.2)}
  .badge-gray{background:rgba(100,116,139,.1);color:var(--text2);border:1px solid rgba(100,116,139,.2)}

  /* ‚îÄ‚îÄ ESTADO SELECT ‚îÄ‚îÄ */
  .estado-sel{
    padding:7px 12px;border-radius:8px;
    border:1.5px solid rgba(255,255,255,.07);
    background:var(--navy3);
    font-family:inherit;font-size:11px;font-weight:700;color:var(--text);
    cursor:pointer;min-width:140px;
  }
  .estado-sel:focus{outline:none;border-color:var(--teal)}

  /* ‚îÄ‚îÄ SEC TITLE ‚îÄ‚îÄ */
  .sec-title{
    font-size:20px;font-weight:800;color:var(--white);
    margin-bottom:24px;display:flex;align-items:center;gap:14px;letter-spacing:-.3px;
  }
  .sec-title-tag{
    font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;
    color:var(--orange);background:rgba(249,115,22,.1);
    padding:4px 12px;border-radius:100px;border:1px solid rgba(249,115,22,.2);
  }
  .sec-title::after{content:'';flex:1;height:1px;background:rgba(255,255,255,.05)}

  /* ‚îÄ‚îÄ LOGO PREVIEW ‚îÄ‚îÄ */
  .logo-preview{max-width:110px;border-radius:8px;margin-top:10px;display:block}

  /* ‚îÄ‚îÄ OVERLAY ‚îÄ‚îÄ */
  .overlay{
    position:fixed;inset:0;background:rgba(0,0,0,.6);
    backdrop-filter:blur(4px);opacity:0;pointer-events:none;
    transition:opacity .3s;z-index:150;
  }
  .overlay.on{opacity:1;pointer-events:auto}
  .filtro-on{box-shadow:0 0 0 2px var(--teal)!important}
  .mono{font-family:'JetBrains Mono',monospace}
  hr.sep{border:none;border-top:1px solid rgba(255,255,255,.06);margin:28px 0}

  /* ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ */
  @keyframes pulse-dot{0%,100%{opacity:1}50%{opacity:.4}}
  .live-dot{
    display:inline-block;width:6px;height:6px;border-radius:50%;
    background:var(--teal);animation:pulse-dot 2s ease infinite;
  }

  /* ‚îÄ‚îÄ WATERMARK CANVAS OVERLAY ‚îÄ‚îÄ */
  .wm-wrap{position:relative}
  .wm-wrap::after{
    content:'GESTIUM ¬∑ IO';
    position:absolute;bottom:10px;right:14px;
    font-size:9px;font-weight:700;letter-spacing:2px;
    color:rgba(6,214,200,.15);pointer-events:none;
    text-transform:uppercase;font-family:'Syne',sans-serif;
  }

  /* ‚îÄ‚îÄ FILTER BAR ‚îÄ‚îÄ */
  .filter-bar{
    background:var(--navy2);border-radius:var(--r2);
    border:1px solid rgba(255,255,255,.05);
    padding:16px 22px;margin-bottom:22px;
    display:flex;gap:10px;flex-wrap:wrap;align-items:center;
  }

  @media(max-width:768px){
    #menuToggle{display:block}
    .sidebar{left:-265px;transition:left .3s ease}
    .sidebar.open{left:0}
    .main{margin-left:0}
    .topbar{padding:0 16px}
    .page{padding:20px 14px}
    .kpi-row{gap:8px}
    .kpi{min-width:calc(50% - 4px);padding:14px}
    .charts-grid{grid-template-columns:1fr}
    .chart-box-full{grid-column:auto}
    table{min-width:500px;font-size:12px}
    th,td{padding:10px 12px}
  }
  </style>
  </head>
  <body>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL EXPLICATIVO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="chip-modal" id="chipModal">
    <div class="chip-modal-content">
      <button class="chip-modal-close" onclick="closeChipModal()">‚úï</button>
      <div class="chip-modal-icon" id="modalIcon">üìä</div>
      <div class="chip-modal-title" id="modalTitle">Dashboard en Vivo</div>
      <div class="chip-modal-desc" id="modalDesc">Visualiza tus ventas en tiempo real</div>
      <ul class="chip-modal-list" id="modalList"></ul>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="loginScreen">
    <div class="login-grid-bg"></div>
    <div class="login-deco">
      <div class="login-hex-decor"></div>
      <div class="login-eyebrow">GESTIUM ¬∑ Sistema Operativo</div>
      <div class="login-headline">
        Inteligencia<br><em>Operativa</em><br>en tiempo real.
      </div>
      <div class="login-tagline">
        Cotizaciones, reportes financieros y control de ventas en un solo ecosistema. Conectado. Preciso.
      </div>
      <div class="login-chips">
        <div class="login-chip" onclick="showChipInfo('dashboard')">üìä Dashboard en vivo</div>
        <div class="login-chip" onclick="showChipInfo('pdf')">üìÑ PDF autom√°tico</div>
        <div class="login-chip" onclick="showChipInfo('multiuser')">‚òÅÔ∏è Multi-usuario</div>
        <div class="login-chip" onclick="showChipInfo('firebase')">üîí Firebase seguro</div>
      </div>
      <div class="login-contact">
        <a href="https://wa.me/573005541411?text=Hola, quiero informaci√≥n sobre GESTIUM" target="_blank" class="contact-btn whats">
          üì± WhatsApp
        </a>
        <a href="mailto:gestium.inteligencia@gmail.com?subject=Consulta sobre GESTIUM" class="contact-btn email">
          ‚úâÔ∏è Email
        </a>
      </div>
      <div style="display:flex;gap:10px;justify-content:center;margin-top:8px">
        <a href="https://www.facebook.com/share/18DSCn8qA3/" target="_blank" rel="noopener noreferrer" style="color:var(--text3);font-size:11px;text-decoration:none;display:flex;align-items:center;gap:4px">
          üìò Facebook
        </a>
      <a href="https://www.instagram.com/gestium_inteligencia_operativa?igsh=emJtamcyZWdmMW15" target="_blank" rel="noopener noreferrer" style="color:var(--text3);font-size:11px;text-decoration:none;display:flex;align-items:center;gap:4px">
        üì∏ Instagram
      </a>      
      <a href="https://www.linkedin.com/company/GestiumInteligenciaOperativa" target="_blank" style="color:var(--text3);font-size:11px;text-decoration:none;display:flex;align-items:center;gap:4px">üíº LinkedIn</a>
      </div>
    </div>
    <div class="login-panel">
      <div class="login-logo-text">GESTIUM <span>¬∑</span></div>
      <div class="login-sub-text">Inteligencia Operativa ¬∑ Premium</div>
      <div style="margin-bottom:16px">
        <label class="f-label">Correo electr√≥nico</label>
        <input id="loginEmail" type="email" class="f-input" placeholder="tu@empresa.com" autocomplete="username">
      </div>
      <div style="margin-bottom:10px">
        <label class="f-label">Contrase√±a</label>
        <div class="pw-wrap">
          <input id="loginPassword" type="password" class="f-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
          <span id="togglePassword" class="pw-eye">üëÅ</span>
        </div>
      </div>
      <div class="login-row">
        <label class="rem-label"><input id="remember" type="checkbox"> Recordarme</label>
        <button id="resetBtn" class="btn btn-ghost btn-sm" type="button">Recuperar acceso</button>
      </div>
      <button id="loginBtn" class="btn btn-primary" type="button">
        <span id="loginText">Iniciar sesi√≥n</span>
        <span id="loginSpinner" style="display:none">‚åõ</span>
      </button>
      <p id="loginMessage" class="login-msg"></p>
      <div class="login-footer">
        ¬øSin cuenta?
        <button id="showRegister" class="btn btn-ghost" style="display:inline;padding:0;margin-left:5px" type="button">Crear cuenta</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê REGISTRO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="registerScreen">
    <div class="reg-card fade-up">
      <div class="reg-head">
        <h2>Crear cuenta</h2>
        <p>Completa la informaci√≥n de tu empresa y usuario administrador</p>
      </div>
      <div class="reg-body">
        <div class="mode-tgl">
          <button class="mode-btn on" id="modeNuevaBtn" type="button">Nueva empresa</button>
          <button class="mode-btn" id="modeExistenteBtn" type="button">Unirme a empresa</button>
        </div>
        <input id="regModoEmpresa" type="hidden" value="nueva">
        <div id="bloqueEmpresaExistente" style="display:none">
          <div class="reg-sep">üè¢ ID de empresa</div>
          <input id="regEmpresaExistente" class="ri" type="text" placeholder="ID de empresa (pide al administrador)">
        </div>
        <div id="bloqueNuevaEmpresa">
          <div class="reg-sep">üè¢ Datos de la empresa</div>
          <input id="regEmpresa" class="ri" type="text" placeholder="Nombre de la empresa *">
          <div class="reg-2">
            <input id="regNitEmpresa" class="ri" type="text" placeholder="NIT / RUT">
            <input id="regTelefonoEmpresa" class="ri" type="tel" placeholder="Tel√©fono empresa">
          </div>
          <input id="regDireccionEmpresa" class="ri" type="text" placeholder="Direcci√≥n">
          <div class="reg-2">
            <input id="regCiudadEmpresa" class="ri" type="text" placeholder="Ciudad">
            <input id="regPaisEmpresa" class="ri" type="text" placeholder="Pa√≠s" value="Colombia">
          </div>
          <input id="regWebEmpresa" class="ri" type="text" placeholder="Sitio web (opcional)">
          <input id="regEmailEmpresa" class="ri" type="email" placeholder="Email de contacto empresa">
        </div>
        <div class="reg-sep">üë§ Administrador</div>
        <div class="reg-2">
          <input id="regNombreUsuario" class="ri" type="text" placeholder="Nombre *">
          <input id="regApellidoUsuario" class="ri" type="text" placeholder="Apellido">
        </div>
        <input id="regCargoUsuario" class="ri" type="text" placeholder="Cargo (ej: Gerente)">
        <div class="reg-2">
          <input id="regCelularUsuario" class="ri" type="tel" placeholder="Celular *">
          <input id="regTelefonoUsuario" class="ri" type="tel" placeholder="Tel√©fono fijo">
        </div>
        <div class="reg-sep">üîê Acceso al sistema</div>
        <input id="regEmail" class="ri" type="email" placeholder="Correo electr√≥nico *">
        <input id="regPassword" class="ri" type="password" placeholder="Contrase√±a (m√≠n. 6 caracteres) *">
        <button id="registerBtn" class="btn btn-primary" style="margin-top:8px" type="button">Crear Cuenta</button>
        <div style="text-align:center;margin-top:14px">
          <button id="backToLogin" class="btn btn-ghost" type="button">‚Üê Volver al login</button>
        </div>
        <p id="registerMessage" class="reg-msg"></p>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê APP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="app">
    <aside class="sidebar" id="sidebar">
      <div class="sb-stripe"></div>
      <div class="sb-top">
        <div class="sb-brand">Gestium IO</div>
        <div class="sb-company" id="sidebarEmpresaNombre">‚Äî</div>
      </div>
      <nav class="sb-nav">
        <div class="sb-section">Principal</div>
        <button class="sb-item" data-modulo="dashboard">
          <span class="sb-dot"></span>Dashboard
        </button>
        <button class="sb-item" data-modulo="cotizaciones">
          <span class="sb-dot"></span>Cotizaciones
        </button>
        <div class="sb-section">Gesti√≥n</div>
        <button class="sb-item" data-modulo="financiero">
          <span class="sb-dot"></span>Finanzas
        </button>
      </nav>
      <div class="sb-footer">
        <!-- Contacto Sidebar -->
        <div class="sb-contact">
          <div class="sb-contact-title">¬øNecesitas ayuda?</div>
          <div class="sb-contact-btns">
            <a href="https://wa.me/573005541411?text=Hola, necesito soporte" target="_blank" class="sb-contact-btn whats">
              üì± WhatsApp
            </a>
            <a href="mailto:gestium.inteligencia@gmail.com?subject=Soporte GESTIUM" class="sb-contact-btn email">
              ‚úâÔ∏è Email
            </a>
          </div>
          <div style="display:flex;gap:8px;justify-content:center;margin-top:8px;flex-wrap:wrap">
          <a href="https://www.facebook.com/share/18DSCn8qA3/" target="_blank" rel="noopener noreferrer" style="color:var(--text3);font-size:10px;text-decoration:none">
            üìò FB
          </a>        
          <a href="https://www.instagram.com/gestium_inteligencia_operativa?igsh=emJtamcyZWdmMW15" target="_blank" rel="noopener noreferrer" style="color:var(--text3);font-size:10px;text-decoration:none">
            üì∏ IG
          </a>          
          <a href="https://www.linkedin.com/company/GestiumInteligenciaOperativa" target="_blank" style="color:var(--text3);font-size:10px;text-decoration:none">üíº LI</a>
          </div>
        </div>
        <div class="user-pill">
          <div class="user-av" id="userAvatar">?</div>
          <div class="user-info">
            <div class="user-name" id="sidebarUserName">‚Äî</div>
            <div class="user-email" id="sidebarUserEmail">‚Äî</div>
          </div>
        </div>
        <button id="sidebarLogout" class="btn-logout">‚èª Cerrar sesi√≥n</button>
      </div>
    </aside>

    <div id="overlay" class="overlay"></div>

    <div class="main">
      <header class="topbar">
        <div style="display:flex;align-items:center;gap:12px">
          <button id="menuToggle">‚ò∞</button>
          <div class="topbar-title" id="topbarTitle">GESTIUM</div>
          <div class="live-dot" style="margin-left:4px"></div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <span class="topbar-badge">PREMIUM</span>
          <button id="btnUploadLogo" class="btn btn-navy btn-sm" type="button">‚¨Ü Logo</button>
          <input type="file" id="logoInput" accept="image/*" style="display:none">
        </div>
      </header>

      <!-- ‚îÄ‚îÄ M√ìDULO COTIZACIONES ‚îÄ‚îÄ -->
      <div id="moduloCotizaciones" class="page" style="display:none">
        <div class="sec-title">
          Cotizaciones
          <span class="sec-title-tag">GESTIUM ¬∑ IO</span>
        </div>

        <div class="card" style="margin-bottom:18px"><div class="card-body">
          <div class="card-title">üë§ Gesti√≥n de Clientes</div>
          <div style="display:grid;grid-template-columns:1fr auto;gap:10px;margin-bottom:14px;align-items:flex-end">
            <div>
              <label class="f-lbl">Nuevo cliente</label>
              <input id="cliente" class="inp" type="text" placeholder="Nombre del cliente">
            </div>
            <button id="guardarClienteBtn" class="btn btn-teal btn-sm" type="button">+ Guardar</button>
          </div>
          <div>
            <label class="f-lbl">Seleccionar cliente existente</label>
            <select id="listaClientes" class="inp"><option value="">-- Seleccionar --</option></select>
          </div>
        </div></div>

        <div class="card" style="margin-bottom:18px"><div class="card-body">
          <div class="card-title">üìê Par√°metros de Cotizaci√≥n</div>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin-bottom:16px">
            <div><label class="f-lbl">Altura (cm)</label><input id="altura" class="inp" type="number" value="38"></div>
            <div><label class="f-lbl">Precio / m¬≥ (COP)</label><input id="precio" class="inp" type="number" value="235000"></div>
            <div><label class="f-lbl">IVA (%)</label><input id="iva" class="inp" type="number" value="19"></div>
          </div>
          <div style="margin-bottom:16px">
            <label class="f-lbl">Medidas ‚Äî formato: cant-anchoXlargo (ej: 2-180*100)</label>
            <textarea id="medidas" class="inp" style="min-height:110px;resize:vertical;font-family:'JetBrains Mono',monospace;font-size:13px" placeholder="2-180*100&#10;3-200x100&#10;1-150*80"></textarea>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button id="generarBtn" class="btn btn-primary" type="button">üìÑ Generar Cotizaci√≥n PDF</button>
            <button id="generarReporteBtn" class="btn btn-teal btn-sm" type="button">üìä Reporte del Mes</button>
          </div>
        </div></div>

        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px">
          <button id="backupBtn" class="btn btn-sm btn-orange" type="button">üíæ Backup JSON</button>
          <input id="restoreInput" type="file" accept=".json" style="display:none">
          <button id="restoreBtn" class="btn btn-sm btn-navy" type="button">üìÇ Restaurar</button>
        </div>
        <img id="logoPreview" class="logo-preview" style="display:none">
      </div>

      <!-- ‚îÄ‚îÄ M√ìDULO DASHBOARD ‚îÄ‚îÄ -->
      <div id="moduloDashboard" class="page" style="display:none">
        <div class="sec-title">
          Dashboard
          <span class="sec-title-tag">GESTIUM ¬∑ IO</span>
        </div>

        <div class="filter-bar">
          <input id="mesReporte" type="month" class="inp" style="width:auto">
          <select id="clienteFiltro" class="inp" style="width:auto;min-width:180px"><option value="">‚Äî Todos los clientes ‚Äî</option></select>
          <button id="actualizarDashboard" class="btn btn-primary btn-sm" type="button">‚Ü∫ Actualizar</button>
          <button id="btnLimpiarFiltros" class="btn btn-sm btn-navy" type="button">‚úï Limpiar</button>
        </div>

        <div class="kpi-row">
          <div class="kpi k-teal"><div class="kpi-lbl">Total Cotizado</div><div class="kpi-val mono" id="kpiCotizado">‚Äî</div></div>
          <div class="kpi k-orange"><div class="kpi-lbl">Ventas Confirmadas</div><div class="kpi-val pos" id="kpiVentas">‚Äî</div></div>
          <div class="kpi k-amber"><div class="kpi-lbl">% Confirmaci√≥n</div><div class="kpi-val mono" id="kpiConversion">‚Äî</div></div>
          <div class="kpi k-gray"><div class="kpi-lbl">Cotizaciones</div><div class="kpi-val mono" id="kpiCantidad">‚Äî</div></div>
          <div class="kpi k-green"><div class="kpi-lbl">Ticket Promedio</div><div class="kpi-val mono" id="kpiPromedio">‚Äî</div></div>
        </div>

        <div class="charts-grid">
          <div class="chart-box chart-box-full wm-wrap">
            <div class="chart-label"><span>‚óè</span> Ventas confirmadas por d√≠a</div>
            <div class="chart-container" style="height:280px">
              <canvas id="graficoVentas"></canvas>
            </div>
          </div>
          <div class="chart-box wm-wrap">
            <div class="chart-label"><span>‚óè</span> Ventas por cliente</div>
            <div class="chart-container" style="height:270px">
              <canvas id="graficoClientes"></canvas>
            </div>
          </div>
          <div class="chart-box wm-wrap">
            <div class="chart-label"><span>‚óè</span> Cotizaciones por estado</div>
            <div class="chart-container" style="height:270px">
              <canvas id="graficoEstados"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ M√ìDULO FINANCIERO ‚îÄ‚îÄ -->
      <div id="moduloFinanciero" class="page" style="display:none">
        <div class="sec-title">
          Finanzas
          <span class="sec-title-tag">GESTIUM ¬∑ IO</span>
        </div>

        <div class="card" style="margin-bottom:18px"><div class="card-body">
          <div class="card-title">üìã Registrar Costo / Gasto</div>
          <div style="display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end">
            <div><label class="f-lbl">Fecha</label><input type="date" id="gastoFecha" class="inp" style="width:auto"></div>
            <div><label class="f-lbl">Cliente</label>
              <select id="gastoCliente" class="inp" style="min-width:155px">
                <option value="">Seleccionar cliente</option>
              </select>
            </div>
            <div><label class="f-lbl">Categor√≠a</label>
              <select id="gastoCategoria" class="inp">
                <option>Materia Prima</option><option>Transporte</option>
                <option>N√≥mina</option><option>Servicios</option><option>Otros</option>
              </select>
            </div>
            <div><label class="f-lbl">Valor (COP)</label><input type="number" id="gastoValor" class="inp" placeholder="0" style="width:140px"></div>
            <div style="flex:1;min-width:160px"><label class="f-lbl">Descripci√≥n</label><input type="text" id="gastoDescripcion" class="inp" placeholder="Descripci√≥n del gasto"></div>
            <button id="guardarGastoBtn" class="btn btn-teal btn-sm" type="button">+ Registrar</button>
          </div>
        </div></div>

        <div class="card" style="margin-bottom:24px"><div class="card-body">
          <div class="card-title">üì¶ Costos Registrados</div>
          <div class="tbl-wrap">
            <table id="tablaGastos">
              <thead><tr><th>Fecha</th><th>Cliente</th><th>Categor√≠a</th><th>Descripci√≥n</th><th>Valor</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div></div>

        <div class="card"><div class="card-body">
          <div class="card-title">üóÇ Cotizaciones del Mes</div>
          <div class="tbl-wrap">
            <table id="tablaCotizaciones">
              <thead><tr><th>N¬∞</th><th>Cliente</th><th>Fecha</th><th>Total</th><th>Estado</th><th>Acciones</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div></div>
      </div>

    </div><!-- /main -->
  </div><!-- /app -->

  <script>
  // ‚îÄ‚îÄ CHIPS MODAL ‚îÄ‚îÄ
  const chipData = {
    dashboard: {
      icon: 'üìä',
      title: 'Dashboard en Vivo',
      desc: 'Monitorea tus ventas y cotizaciones en tiempo real con gr√°ficos interactivos.',
      items: [
        'Visualizaci√≥n de KPIs clave (ventas, conversi√≥n, tickets)',
        'Gr√°ficos de ventas por d√≠a, cliente y estado',
        'Filtros avanzados por mes y cliente',
        'Actualizaci√≥n instant√°nea de datos'
      ]
    },
    pdf: {
      icon: 'üìÑ',
      title: 'PDF Autom√°tico',
      desc: 'Genera cotizaciones y reportes profesionales con un solo clic.',
      items: [
        'Cotizaciones con tu logo y datos de empresa',
        'C√°lculo autom√°tico de m¬≥, subtotales e IVA',
        'Reportes mensuales de ventas',
        'Marca de agua GESTIUM en cada documento'
      ]
    },
    multiuser: {
      icon: '‚òÅÔ∏è',
      title: 'Multi-usuario',
      desc: 'Colabora con tu equipo desde cualquier dispositivo, en cualquier lugar.',
      items: [
        'Acceso simult√°neo para m√∫ltiples usuarios',
        'Sincronizaci√≥n autom√°tica en la nube',
        'Roles y permisos configurables',
        'Compatible con m√≥vil, tablet y PC'
      ]
    },
    firebase: {
      icon: 'üîí',
      title: 'Firebase Seguro',
      desc: 'Tu informaci√≥n protegida con la infraestructura de Google.',
      items: [
        'Autenticaci√≥n segura con encriptaci√≥n',
        'Backup autom√°tico en la nube',
        'Protecci√≥n contra accesos no autorizados',
        'Recuperaci√≥n de contrase√±a por email'
      ]
    }
  };

  function showChipInfo(type) {
    const data = chipData[type];
    if (!data) return;
    document.getElementById('modalIcon').textContent = data.icon;
    document.getElementById('modalTitle').textContent = data.title;
    document.getElementById('modalDesc').textContent = data.desc;
    const list = document.getElementById('modalList');
    list.innerHTML = '';
    data.items.forEach(item => {
      const li = document.createElement('li');
      li.textContent = item;
      list.appendChild(li);
    });
    document.getElementById('chipModal').classList.add('show');
  }

  function closeChipModal() {
    document.getElementById('chipModal').classList.remove('show');
  }

  // Cerrar modal al hacer clic fuera
  document.getElementById('chipModal').addEventListener('click', (e) => {
    if (e.target.id === 'chipModal') closeChipModal();
  });
  </script>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import {
    getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword,
    onAuthStateChanged, signOut, sendPasswordResetEmail,
    setPersistence, browserLocalPersistence, browserSessionPersistence
  } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
  import {
    getFirestore, collection, doc, getDoc, getDocs, addDoc,
    setDoc, updateDoc, deleteDoc, query, orderBy, where,
    Timestamp, runTransaction
  } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey:            "AIzaSyBF246-DxbLTyH-zXHlrSh92_Tq2JD7cfE",
    authDomain:        "gestium-2d40b.firebaseapp.com",
    projectId:         "gestium-2d40b",
    storageBucket:     "gestium-2d40b.firebasestorage.app",
    messagingSenderId: "949260689854",
    appId:             "1:949260689854:web:0b69f4e7d8ed0e9ac759ef"
  };
  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  /* ‚îÄ‚îÄ PALETA ‚îÄ‚îÄ */
  const P = {
    teal:    '#06d6c8', teal2: '#22d3ee', teal3: '#67e8f9',
    orange:  '#f97316', orange2:'#fb923c',
    amber:   '#f59e0b', red: '#ef4444', green: '#10b981',
    navy:    '#0d1629', gray: '#64748b', gray2: '#94a3b8',
  };
  const PALETTE = [P.teal,P.orange,P.amber,P.green,P.teal2,'#8b5cf6','#ec4899',P.gray2];

  /* ‚îÄ‚îÄ FORMATO DECIMALES ‚îÄ‚îÄ */
  function formatM3(n) {
    // Elimina ceros innecesarios: 85.500 ‚Üí 85.5
    return parseFloat(parseFloat(n).toFixed(3)).toString();
  }

  /* ‚îÄ‚îÄ WATERMARK en PDF ‚îÄ‚îÄ */
  function addPdfWatermark(docPdf) {
    const pw = docPdf.internal.pageSize.getWidth();
    const ph = docPdf.internal.pageSize.getHeight();
    try {
      docPdf.saveGraphicsState();
      docPdf.setGState(new docPdf.GState({ opacity: 0.04 }));
      docPdf.setFont("helvetica","bold");
      docPdf.setFontSize(48);
      docPdf.setTextColor(6,214,200);
      docPdf.text("GESTIUM", pw/2, ph/2, { align:"center", angle:45 });
      docPdf.restoreGraphicsState();
    } catch(e){}
    docPdf.setFontSize(7);
    docPdf.setTextColor(150,150,150);
    docPdf.setFont("helvetica","normal");
    docPdf.text("GESTIUM ¬∑ Inteligencia Operativa ¬∑ WA: +57 300 554 1411 ¬∑ gestium.inteligencia@gmail.com", pw/2, ph - 10, { align:"center" });
  }

  window.addEventListener('DOMContentLoaded', () => {

    const $ = id => document.getElementById(id);
    const fmt = f => {
      const d = f instanceof Date ? f : new Date(f);
      return d.toLocaleString("es-CO",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:false});
    };
    const clp = n => "$ " + Number(n).toLocaleString("es-CO");

    const loginScreen    = $("loginScreen");
    const registerScreen = $("registerScreen");
    const appDiv         = $("app");

      document.addEventListener("click", async (e) => {
      if (e.target && e.target.id === "sidebarLogout") {
        try {
          await signOut(auth);
        } catch (err) {
          alert("Error cerrando sesi√≥n: " + err.message);
        }
      }
    });

    let empresaId=null, empresaData=null, usuarioData=null, logoB64=null;
    let chartV=null, chartC=null, chartE=null;
    let ventasMes=[], cotizTotal=0, vendidoTotal=0;
    let filtroCliente="", filtroEstado="";

    /* ‚îÄ‚îÄ MODO REGISTRO ‚îÄ‚îÄ */
    $("modeNuevaBtn").addEventListener("click",()=>{
      $("regModoEmpresa").value="nueva";
      $("modeNuevaBtn").classList.add("on"); $("modeExistenteBtn").classList.remove("on");
      $("bloqueNuevaEmpresa").style.display="block"; $("bloqueEmpresaExistente").style.display="none";
    });
    $("modeExistenteBtn").addEventListener("click",()=>{
      $("regModoEmpresa").value="existente";
      $("modeExistenteBtn").classList.add("on"); $("modeNuevaBtn").classList.remove("on");
      $("bloqueNuevaEmpresa").style.display="none"; $("bloqueEmpresaExistente").style.display="block";
    });
    $("showRegister").addEventListener("click",()=>{ loginScreen.style.display="none"; registerScreen.style.display="flex"; });
    $("backToLogin").addEventListener("click",()=>{ registerScreen.style.display="none"; loginScreen.style.display="flex"; });

    /* ‚îÄ‚îÄ REGISTRO ‚îÄ‚îÄ */
    $("registerBtn").addEventListener("click", async()=>{
      const msg=$("registerMessage"); msg.textContent="";
      const modo=$("regModoEmpresa").value;
      const nomEmp=$("regEmpresa").value.trim();
      const nitEmp=$("regNitEmpresa").value.trim(), telEmp=$("regTelefonoEmpresa").value.trim();
      const dirEmp=$("regDireccionEmpresa").value.trim(), ciudadEmp=$("regCiudadEmpresa").value.trim();
      const paisEmp=$("regPaisEmpresa").value.trim(), webEmp=$("regWebEmpresa").value.trim();
      const emailEmp=$("regEmailEmpresa").value.trim();
      const nomUser=$("regNombreUsuario").value.trim(), apUser=$("regApellidoUsuario").value.trim();
      const cargoUser=$("regCargoUsuario").value.trim(), celUser=$("regCelularUsuario").value.trim();
      const telUser=$("regTelefonoUsuario").value.trim();
      const email=$("regEmail").value.trim(), password=$("regPassword").value;
      const idExistente=$("regEmpresaExistente").value.trim();
      if(!nomUser||!celUser||!email||!password){ msg.textContent="Nombre, celular, correo y contrase√±a son obligatorios"; return; }
      if(password.length<6){ msg.textContent="La contrase√±a debe tener al menos 6 caracteres"; return; }
      if(modo==="nueva"&&!nomEmp){ msg.textContent="Escribe el nombre de la empresa"; return; }
      if(modo==="existente"&&!idExistente){ msg.textContent="Ingresa el ID de la empresa"; return; }
      try {
        const cred=await createUserWithEmailAndPassword(auth,email,password);
        const user=cred.user; let empId="";
        if(modo==="nueva"){
          const empRef=doc(collection(db,"empresas")); empId=empRef.id;
          const trial=new Date(); trial.setDate(trial.getDate()+7);
          await setDoc(empRef,{nombre:nomEmp, nit:nitEmp||"", telefono:telEmp||"",
            direccion:dirEmp||"", ciudad:ciudadEmp||"", pais:paisEmp||"Colombia",
            web:webEmp||"", email:emailEmp||email,
            plan:"trial", contador:0,
            activa:true,
            fechaVencimiento:Timestamp.fromDate(trial),
            vencimiento:Timestamp.fromDate(trial),
            logo:null,
            creadaEn:Timestamp.fromDate(new Date()),
            onboardingCompletado:false
          });
        } else {
          empId=idExistente;
          const s=await getDoc(doc(db,"empresas",empId));
          if(!s.exists()){ msg.textContent="Empresa no encontrada"; return; }
        }
        // ‚úÖ Arquitectura multiempresa correcta
        // 1. Usuario en subcolecci√≥n de empresa
        await setDoc(doc(db,"empresas",empId,"usuarios",user.uid),{
          email:user.email, nombre:nomUser, apellido:apUser||"", cargo:cargoUser||"",
          celular:celUser, telefono:telUser||"", rol:"admin", activo:true,
          superadmin:false, creadoEn:Timestamp.fromDate(new Date())
        });
        // 2. Meta ligero para lookup r√°pido en login
        await setDoc(doc(db,"usuariosMeta",user.uid),{
          empresaId:empId, email:user.email, creadoEn:Timestamp.fromDate(new Date())
        });
        // 3. Inicializar contador OCR mensual (mes actual = 0)
        const mesKey = new Date().toISOString().slice(0,7);
        await setDoc(doc(db,"empresas",empId,"ocrUsage",mesKey),{
          count:0, mes:mesKey, empresaId:empId
        },{merge:true});
        alert("¬°Cuenta creada! Inicia sesi√≥n.");
        registerScreen.style.display="none"; loginScreen.style.display="flex";
      } catch(e){ msg.textContent=e.message||"Error creando cuenta"; }
    });

    /* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
    $("togglePassword").addEventListener("click",()=>{
      const p=$("loginPassword"); p.type=p.type==="password"?"text":"password";
      $("togglePassword").textContent=p.type==="password"?"üëÅ":"üôà";
    });
    function setLL(on){ $("loginBtn").disabled=on; $("loginText").style.display=on?"none":"inline"; $("loginSpinner").style.display=on?"inline":"none"; }
    function errVisual(){
      ["loginEmail","loginPassword"].forEach(id=>$(id).classList.add("input-error"));
      $("loginBtn").classList.add("shake"); setTimeout(()=>$("loginBtn").classList.remove("shake"),350);
      const c=()=>{ ["loginEmail","loginPassword"].forEach(id=>$(id).classList.remove("input-error")); $("loginEmail").removeEventListener("input",c); $("loginPassword").removeEventListener("input",c); };
      $("loginEmail").addEventListener("input",c); $("loginPassword").addEventListener("input",c);
    }
    $("loginBtn").addEventListener("click", async()=>{
      $("loginMessage").textContent="";
      const e=$("loginEmail").value.trim(), p=$("loginPassword").value;
      if(!e||!p){ $("loginMessage").textContent="Ingresa correo y contrase√±a"; return; }
      setLL(true);
      try {
        await setPersistence(auth,$("remember").checked?browserLocalPersistence:browserSessionPersistence);
        await signInWithEmailAndPassword(auth,e,p);
      } catch(err){
        const m={"auth/user-not-found":"El usuario no existe.","auth/wrong-password":"Contrase√±a incorrecta.","auth/invalid-email":"Correo no v√°lido.","auth/invalid-credential":"Correo o contrase√±a incorrectos.","auth/too-many-requests":"Demasiados intentos."};
        $("loginMessage").textContent=m[err.code]||"Error al iniciar sesi√≥n."; errVisual(); setLL(false);
      }
    });
    $("resetBtn").addEventListener("click", async()=>{
      const e=$("loginEmail").value.trim(); if(!e){ $("loginMessage").textContent="Escribe tu correo"; return; }
      try { await sendPasswordResetEmail(auth,e); $("loginMessage").style.color=P.teal; $("loginMessage").textContent="Correo enviado ‚úì"; setTimeout(()=>{ $("loginMessage").textContent=""; $("loginMessage").style.color=""; },4000); }
      catch(err){ $("loginMessage").textContent=err.message; }
    });

    /* ‚îÄ‚îÄ AUTH STATE ‚îÄ‚îÄ */
  onAuthStateChanged(auth, async(user)=>{
    try {

      if(!user){
        loginScreen.style.display="flex";
        appDiv.style.display="none";
        return;
      }

      // 1Ô∏è‚É£ Buscar meta para saber a qu√© empresa pertenece
      const metaSnap = await getDoc(doc(db,"usuariosMeta", user.uid));

      if(!metaSnap.exists()){
        alert("Usuario sin empresa asignada.");
        await signOut(auth);
        return;
      }

      empresaId = metaSnap.data().empresaId;

      // 2Ô∏è‚É£ Buscar usuario dentro de su empresa
      const userSnap = await getDoc(
        doc(db,"empresas",empresaId,"usuarios",user.uid)
      );

      if(!userSnap.exists()){
        alert("Usuario no configurado correctamente.");
        await signOut(auth);
        return;
      }

      usuarioData = userSnap.data();

      if(!usuarioData.activo){
        alert("Usuario desactivado.");
        await signOut(auth);
        return;
      }

      // 3Ô∏è‚É£ Cargar empresa
      const empresaSnap = await getDoc(doc(db,"empresas",empresaId));

      if(!empresaSnap.exists()){
        alert("Empresa no encontrada.");
        await signOut(auth);
        return;
      }

      empresaData = empresaSnap.data();

      if(empresaData.vencimiento &&
        new Date() > empresaData.vencimiento.toDate()){
        alert("Plan vencido.");
        await signOut(auth);
        return;
      }

      // 4Ô∏è‚É£ Render UI
      $("sidebarEmpresaNombre").textContent = empresaData.nombre || "Mi Empresa";
      $("topbarTitle").textContent = empresaData.nombre || "Mi Empresa";

      const nombre = [usuarioData.nombre, usuarioData.apellido]
        .filter(Boolean).join(" ");

      $("sidebarUserName").textContent = nombre;
      $("sidebarUserEmail").textContent = user.email;

      $("userAvatar").textContent =
        (usuarioData.nombre || "?")[0].toUpperCase();

      logoB64 = empresaData.logo || null;

      if(logoB64){
        $("logoPreview").src = logoB64;
        $("logoPreview").style.display = "block";
      }

      await cargarClientes();

      loginScreen.style.display="none";
      appDiv.style.display="block";

      mostrarModulo("cotizaciones");

    } catch(err){
      alert("Error cargando sesi√≥n: " + err.message);
      await signOut(auth);
    }});



    /* ‚îÄ‚îÄ MOBILE ‚îÄ‚îÄ */
    const sidebar=$("sidebar"), overlay=$("overlay");
    $("menuToggle").addEventListener("click",()=>{ sidebar.classList.toggle("open"); overlay.classList.toggle("on"); });
    overlay.addEventListener("click",()=>{ sidebar.classList.remove("open"); overlay.classList.remove("on"); });

    /* ‚îÄ‚îÄ NAVEGACI√ìN ‚îÄ‚îÄ */
    window.mostrarModulo = function(n){
      ["moduloCotizaciones","moduloDashboard","moduloFinanciero"].forEach(id=>$(id).style.display="none");
      if(n==="cotizaciones") $("moduloCotizaciones").style.display="block";
      if(n==="dashboard")    { $("moduloDashboard").style.display="block"; actualizarDashboard(); }
      if(n==="financiero")   { $("moduloFinanciero").style.display="block"; cargarCostos(); actualizarKPIs(); cargarCotizacionesMes(); }
    };
    document.querySelectorAll(".sb-item[data-modulo]").forEach(b=>{
      b.addEventListener("click",()=>{
        document.querySelectorAll(".sb-item").forEach(x=>x.classList.remove("active"));
        b.classList.add("active"); mostrarModulo(b.dataset.modulo);
        sidebar.classList.remove("open"); overlay.classList.remove("on");
      });
    });

    /* ‚îÄ‚îÄ CLIENTES ‚îÄ‚îÄ */
    async function cargarClientes(){
      if(!empresaId) return;
      ["listaClientes","clienteFiltro","gastoCliente"].forEach(id=>{
        const s=$(id); if(!s) return;
        s.innerHTML=id==="gastoCliente"?'<option value="">Seleccionar cliente</option>':'<option value="">-- Seleccionar --</option>';
      });
      const snap=await getDocs(query(collection(db,"empresas",empresaId,"clientes"),orderBy("creadoEn","desc")));
      snap.forEach(d=>{
        const n=d.data().nombre||d.id||"Sin nombre";
        const o=document.createElement("option"); o.value=n; o.textContent=n;
        ["listaClientes","clienteFiltro","gastoCliente"].forEach(id=>{ const s=$(id); if(s) s.appendChild(o.cloneNode(true)); });
      });
    }
    $("guardarClienteBtn").addEventListener("click", async()=>{
      const n=$("cliente").value.trim(); if(!n){ alert("Escribe un cliente"); return; }
      const col=collection(db,"empresas",empresaId,"clientes");
      const snap=await getDocs(col); let existe=false;
      snap.forEach(d=>{ if((d.data().nombre||"").toLowerCase()===n.toLowerCase()) existe=true; });
      if(existe){ alert("Ese cliente ya existe."); return; }
      await addDoc(col,{nombre:n,nombreNormalizado:n.toLowerCase(),creadoEn:Timestamp.fromDate(new Date())});
      await cargarClientes(); $("cliente").value=""; alert("Cliente guardado ‚úì");
    });
    $("listaClientes").addEventListener("change",()=>{ $("cliente").value=$("listaClientes").value; });
    $("clienteFiltro").addEventListener("change",()=>{ filtroCliente=($("clienteFiltro").value||"").trim(); actualizarDashboard(); });
    $("btnLimpiarFiltros").addEventListener("click",()=>{ filtroCliente=""; $("clienteFiltro").value=""; actualizarDashboard(); });

    /* ‚îÄ‚îÄ PDF HEADER ‚îÄ‚îÄ */
    function pdfHeader(docPdf, numero, label){
      const pw=docPdf.internal.pageSize.getWidth(), emp=empresaData||{}, H=96;
      docPdf.setFillColor(7,13,26); docPdf.rect(0,0,pw,H,"F");
      docPdf.setFillColor(6,214,200); docPdf.rect(0,0,pw,3,"F");
      docPdf.setFillColor(249,115,22); docPdf.rect(0,H-3,pw,3,"F");
      if(logoB64){
        try{ const t=logoB64.startsWith("data:image/png")?"PNG":"JPEG"; docPdf.addImage(logoB64,t,34,12,80,44); }catch(e){}
      }
      docPdf.setTextColor(255,255,255);
      docPdf.setFont("helvetica","bold"); docPdf.setFontSize(16);
      docPdf.text(emp.nombre||"Mi Empresa",pw-34,26,{align:"right"});
      docPdf.setFont("helvetica","normal"); docPdf.setFontSize(8); let yd=38;
      if(emp.nit){ docPdf.text("NIT: "+emp.nit,pw-34,yd,{align:"right"}); yd+=10; }
      const dir=[emp.direccion,emp.ciudad,emp.pais].filter(Boolean).join(", ");
      if(dir){ docPdf.text(dir,pw-34,yd,{align:"right"}); yd+=10; }
      if(emp.telefono){ docPdf.text("Tel: "+emp.telefono,pw-34,yd,{align:"right"}); yd+=10; }
      if(emp.web){ docPdf.text(emp.web,pw-34,yd,{align:"right"}); yd+=10; }
      if(emp.email){ docPdf.text(emp.email,pw-34,yd,{align:"right"}); }
      docPdf.setFillColor(249,115,22);
      docPdf.rect(34,H+10,6,30,"F");
      docPdf.setTextColor(249,115,22); docPdf.setFont("helvetica","bold"); docPdf.setFontSize(13);
      docPdf.text(label+": "+numero,44,H+22);
      docPdf.setFont("helvetica","normal"); docPdf.setFontSize(9); docPdf.setTextColor(80,80,80);
      docPdf.text("Fecha: "+fmt(new Date()),44,H+34);
      const asesor=[usuarioData?.nombre,usuarioData?.apellido].filter(Boolean).join(" ");
      if(asesor||usuarioData?.celular){
        let ya=H+46;
        if(asesor){ docPdf.text("Asesor: "+asesor+(usuarioData?.cargo?" ¬∑ "+usuarioData.cargo:""),44,ya); ya+=12; }
        if(usuarioData?.celular){ docPdf.text("Cel: "+usuarioData.celular,44,ya); }
      }
      addPdfWatermark(docPdf);
      return H+75;
    }
    function attachAT(d){
      if(d.autoTable) return;
      try{ const a=window.jspdf?.jsPDF?.API?.autoTable; if(a) d.autoTable=(...x)=>a.call(d,...x); }catch(e){}
    }

    /* ‚îÄ‚îÄ GENERAR COTIZACI√ìN ‚îÄ‚îÄ */
    $("generarBtn").addEventListener("click", async()=>{
      if(!empresaId) return alert("Sin empresa activa");
      const cliente=$("cliente").value.trim()||"Cliente";
      const altura=parseFloat($("altura").value)||0, precio=parseFloat($("precio").value)||0;
      const ivaP=parseFloat($("iva").value)||0, texto=$("medidas").value.trim();
      if(!texto) return alert("Ingresa medidas");
      if(altura<=0||precio<=0) return alert("Altura y precio deben ser > 0");
      let filas=[], subtotal=0, totalM3=0;
      texto.split("\n").forEach(raw=>{
        let l=raw.trim().replace(/\s+/g,""); if(!l) return;
        let cant=1;
        if(l.includes("-")){ const pts=l.split("-"); cant=parseInt(pts[0])||1; l=pts[1]; }
        l=l.toUpperCase();
        const pts=l.includes("*")?l.split("*"):l.split("X");
        const a=parseFloat(pts[0]),b=parseFloat(pts[1]); if(!a||!b) return;
        const m3=(a/100)*(b/100)*(altura/100)*cant, tl=m3*precio;
        subtotal+=tl; totalM3+=m3;
        filas.push([cant,a,b,altura,formatM3(m3),clp(tl)]);
      });
      const ivaT=subtotal*(ivaP/100), total=subtotal+ivaT;
      const empRef=doc(db,"empresas",empresaId); let num="";
      try {
        await runTransaction(db, async(tx)=>{
          const es=await tx.get(empRef); if(!es.exists()) throw "Empresa no encontrada";
          const cnt=(es.data().contador||0)+1;
          num="COT-"+String(cnt).padStart(3,"0");
          tx.update(empRef,{contador:cnt});
          tx.set(doc(collection(db,"empresas",empresaId,"cotizaciones")),{
            numero:num,cliente,fecha:Timestamp.fromDate(new Date()),
            subtotal,iva:ivaT,total,m3:totalM3,estado:"Pendiente",
            medidasTexto:texto,altura,precio,ivaPorcentaje:ivaP
          });
        });
      } catch(e){ alert("Error: "+e); return; }
      const {jsPDF}=window.jspdf;
      const docPdf=new jsPDF({unit:"pt",format:"a4"}); const pw=docPdf.internal.pageSize.getWidth();
      attachAT(docPdf);
      const sy=pdfHeader(docPdf,num,"Cotizaci√≥n");
      docPdf.setFont("helvetica","bold"); docPdf.setFontSize(10); docPdf.setTextColor(40);
      docPdf.text("Para:",38,sy); docPdf.setFont("helvetica","normal"); docPdf.setTextColor(249,115,22); docPdf.text(cliente,76,sy);
      try {
        docPdf.autoTable({
          startY:sy+14,
          head:[["Cant","Ancho cm","Largo cm","Altura cm","m¬≥","Total"]],
          body:filas,theme:"grid",
          headStyles:{fillColor:[7,13,26],textColor:[6,214,200],fontStyle:"bold",fontSize:9},
          alternateRowStyles:{fillColor:[248,250,252]},
          styles:{halign:"center",cellPadding:8,fontSize:10},
          margin:{left:38,right:38}
        });
      } catch(e){}
      const fy=docPdf.lastAutoTable?docPdf.lastAutoTable.finalY+18:270;
      docPdf.setDrawColor(6,214,200); docPdf.setLineWidth(.5); docPdf.line(38,fy,pw-38,fy);
      docPdf.setFontSize(10); docPdf.setTextColor(80,80,80); docPdf.setFont("helvetica","normal");
      docPdf.text("Subtotal:",pw-200,fy+16); docPdf.text(clp(subtotal),pw-38,fy+16,{align:"right"});
      docPdf.text("IVA ("+ivaP+"%):",pw-200,fy+30); docPdf.text(clp(ivaT),pw-38,fy+30,{align:"right"});
      docPdf.setFillColor(7,13,26); docPdf.roundedRect(pw-210,fy+38,172,24,4,4,"F");
      docPdf.setFont("helvetica","bold"); docPdf.setFontSize(13); docPdf.setTextColor(6,214,200);
      docPdf.text("TOTAL: "+clp(total),pw-44,fy+54,{align:"right"});
      docPdf.setFont("helvetica","normal"); docPdf.setFontSize(9); docPdf.setTextColor(130);
      docPdf.text("Gracias por confiar en "+(empresaData.nombre||"nosotros")+".",38,fy+80);
      if(empresaData.telefono) docPdf.text("Contacto: "+empresaData.telefono,38,fy+92);
      docPdf.save(num+" - "+cliente.replace(/\s+/g,"_")+".pdf");
      await actualizarDashboard(); alert("Cotizaci√≥n generada: "+num+" ‚úì");
    });

    /* ‚îÄ‚îÄ REDESCARGAR ‚îÄ‚îÄ */
    window.redescargarCotizacion = async function(id){
      const snap=await getDoc(doc(db,"empresas",empresaId,"cotizaciones",id));
      if(!snap.exists()){ alert("No encontrada"); return; }
      const d=snap.data(); if(!d.medidasTexto){ alert("Datos incompletos"); return; }
      const {jsPDF}=window.jspdf;
      const docPdf=new jsPDF({unit:"pt",format:"a4"}); const pw=docPdf.internal.pageSize.getWidth();
      attachAT(docPdf);
      const sy=pdfHeader(docPdf,d.numero,"Cotizaci√≥n");
      docPdf.setFont("helvetica","bold"); docPdf.setFontSize(10); docPdf.setTextColor(40);
      docPdf.text("Para:",38,sy); docPdf.setFont("helvetica","normal"); docPdf.setTextColor(249,115,22); docPdf.text(d.cliente,76,sy);
      let filas=[];
      d.medidasTexto.split("\n").forEach(raw=>{
        let l=raw.trim().replace(/\s+/g,""); if(!l) return;
        let cant=1; if(l.includes("-")){ const pts=l.split("-"); cant=parseInt(pts[0])||1; l=pts[1]; }
        l=l.toUpperCase();
        const pts=l.includes("*")?l.split("*"):l.split("X");
        const a=parseFloat(pts[0]),b=parseFloat(pts[1]);
        const m3=(a/100)*(b/100)*(d.altura/100)*cant;
        filas.push([cant,a,b,d.altura,formatM3(m3),clp(m3*d.precio)]);
      });
      try{ docPdf.autoTable({startY:sy+14,head:[["Cant","Ancho cm","Largo cm","Altura cm","m¬≥","Total"]],body:filas,theme:"grid",headStyles:{fillColor:[7,13,26],textColor:[6,214,200],fontStyle:"bold",fontSize:9},styles:{halign:"center",cellPadding:8,fontSize:10},margin:{left:38,right:38}}); }catch(e){}
      const fy=docPdf.lastAutoTable?docPdf.lastAutoTable.finalY+18:270;
      docPdf.setFillColor(7,13,26); docPdf.roundedRect(pw-210,fy+10,172,24,4,4,"F");
      docPdf.setFont("helvetica","bold"); docPdf.setFontSize(13); docPdf.setTextColor(6,214,200);
      docPdf.text("TOTAL: "+clp(d.total),pw-44,fy+26,{align:"right"});
      docPdf.save(d.numero+".pdf");
    };

    /* ‚îÄ‚îÄ CAMBIAR ESTADO ‚îÄ‚îÄ */
    window.cambiarEstadoCotizacion = async function(id,accion){
      if(!accion) return;
      const ref=doc(db,"empresas",empresaId,"cotizaciones",id);
      if(accion==="Confirmar"){
        const s=await getDoc(ref); if(!s.exists()) return;
        const d=s.data(); if(d.estado==="Convertida") return;
        await addDoc(collection(db,"empresas",empresaId,"ventas"),{numero:d.numero,cliente:d.cliente,fecha:Timestamp.fromDate(new Date()),subtotal:d.subtotal,iva:d.iva,total:d.total,m3:d.m3});
        await updateDoc(ref,{estado:"Convertida"});
      }
      if(accion==="En espera") await updateDoc(ref,{estado:"En espera"});
      if(accion==="Eliminar"){ if(!confirm("¬øEliminar cotizaci√≥n? Se ocultar√° del sistema.")) return; await updateDoc(ref,{estado:"Cancelada"}); }
      await actualizarDashboard(); cargarCotizacionesMes();
    };

    /* ‚îÄ‚îÄ REPORTE MENSUAL ‚îÄ‚îÄ */
    $("generarReporteBtn").addEventListener("click", async()=>{
      if(!empresaId) return alert("Sin empresa activa");
      const mv=$("mesReporte").value; if(!mv) return alert("Selecciona mes en el Dashboard");
      const [anio,mes]=mv.split("-");
      const snap=await getDocs(query(collection(db,"empresas",empresaId,"cotizaciones"),orderBy("fecha","desc")));
      let filas=[], total=0, totalM3=0;
      snap.forEach(d=>{
        const v=d.data(); if(!v?.fecha) return;
        const f=v.fecha.toDate();
        if(f.getFullYear()==parseInt(anio)&&(f.getMonth()+1)==parseInt(mes)&&v.estado==="Convertida"){
          filas.push([v.numero||"-",v.cliente||"-",fmt(f),formatM3(v.m3||0),clp(v.total||0)]);
          total+=Number(v.total||0); totalM3+=Number(v.m3||0);
        }
      });
      if(!filas.length) return alert("No hay ventas confirmadas en ese per√≠odo.");
      const {jsPDF}=window.jspdf;
      const docPdf=new jsPDF(); const pw=docPdf.internal.pageSize.getWidth();
      attachAT(docPdf);
      docPdf.setFillColor(7,13,26); docPdf.rect(0,0,pw,36,"F");
      docPdf.setFillColor(6,214,200); docPdf.rect(0,0,pw,3,"F");
      if(logoB64){ try{ const t=logoB64.startsWith("data:image/png")?"PNG":"JPEG"; docPdf.addImage(logoB64,t,10,5,44,26); }catch(e){} }
      docPdf.setTextColor(255,255,255); docPdf.setFont("helvetica","bold"); docPdf.setFontSize(14);
      docPdf.text("REPORTE MENSUAL DE VENTAS",pw/2,16,{align:"center"});
      docPdf.setFont("helvetica","normal"); docPdf.setFontSize(9);
      docPdf.text(empresaData.nombre||"",pw/2,26,{align:"center"});
      docPdf.setFillColor(249,115,22); docPdf.rect(0,33,pw,3,"F");
      addPdfWatermark(docPdf);
      let y=46; const emp=empresaData||{};
      if(emp.nit){ docPdf.setTextColor(40); docPdf.text("NIT: "+emp.nit,14,y); y+=9; }
      docPdf.setFont("helvetica","bold"); docPdf.setTextColor(249,115,22);
      docPdf.text("Per√≠odo: "+mv,14,y); y+=9;
      docPdf.setFont("helvetica","normal"); docPdf.setTextColor(80,80,80);
      docPdf.text("Generado: "+fmt(new Date()),14,y); y+=14;
      try{ docPdf.autoTable({startY:y,head:[["N¬∞","Cliente","Fecha","m¬≥","Total"]],body:filas,theme:"grid",headStyles:{fillColor:[7,13,26],textColor:[6,214,200],fontSize:9},alternateRowStyles:{fillColor:[248,250,252]},styles:{fontSize:9}}); }catch(e){}
      const yf=docPdf.lastAutoTable?docPdf.lastAutoTable.finalY+16:100;
      docPdf.setFont("helvetica","bold"); docPdf.setFontSize(11); docPdf.setTextColor(7,13,26);
      docPdf.text("Total m¬≥: "+formatM3(totalM3),14,yf+14);
      docPdf.setTextColor(249,115,22);
      docPdf.text("Total Ventas: "+clp(total),14,yf+28);
      docPdf.save("ReporteVentas_"+mv+".pdf");
    });

    /* ‚îÄ‚îÄ COSTOS ‚îÄ‚îÄ */
    const gastoFecha=$("gastoFecha"); if(gastoFecha) gastoFecha.valueAsDate=new Date();
    $("guardarGastoBtn").addEventListener("click", async()=>{
      if(!empresaId) return;
      const fecha=new Date($("gastoFecha").value+"T"+new Date().toTimeString().slice(0,5));
      const cli=$("gastoCliente").value, cat=$("gastoCategoria").value;
      const val=Number($("gastoValor").value.replace(/\./g,"").replace(",","."));
      const desc=$("gastoDescripcion").value.trim();
      if(!fecha||!val||!cli){ alert("Completa fecha, cliente y valor"); return; }
      await addDoc(collection(db,"empresas",empresaId,"gastos"),{fecha:Timestamp.fromDate(fecha),cliente:cli,categoria:cat,descripcion:desc,valor:val});
      $("gastoValor").value=""; $("gastoDescripcion").value="";
      await cargarCostos();
    });
    async function cargarCostos(){
      const tbody=document.querySelector("#tablaGastos tbody");
      if(!tbody||!empresaId) return;
      const snap=await getDocs(collection(db,"empresas",empresaId,"gastos"));
      tbody.innerHTML="";
      snap.forEach(d=>{
        const g=d.data();
        tbody.innerHTML+=`<tr><td>${fmt(g.fecha.toDate())}</td><td>${g.cliente||"-"}</td><td>${g.categoria}</td><td>${g.descripcion||"-"}</td><td class="mono">${clp(g.valor)}</td></tr>`;
      });
    }

    /* ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ */
    $("actualizarDashboard").addEventListener("click", actualizarDashboard);

    // Doble clic en el √°rea del dashboard ‚Üí limpiar filtros
    $("moduloDashboard")?.addEventListener("dblclick", (evt)=>{
      if(evt.target.closest("canvas")) return; // solo si no es un gr√°fico
      if(filtroCliente||filtroEstado){
        filtroCliente=""; filtroEstado="";
        document.querySelectorAll(".filtro-on").forEach(el=>el.classList.remove("filtro-on"));
        actualizarDashboard();
      }
    });

    async function actualizarDashboard(){
      if(!empresaId) return;
      document.body.style.cursor="wait";
      const mesI=$("mesReporte");
      if(!mesI.value){ const h=new Date(); mesI.value=`${h.getFullYear()}-${String(h.getMonth()+1).padStart(2,"0")}`; }
      const anio=Number(mesI.value.substring(0,4)), mes=Number(mesI.value.substring(5,7))-1;

        const inicioMes = new Date(anio, mes, 1);
        const finMes = new Date(anio, mes + 1, 1);

        const snap = await getDocs(
          query(
            collection(db,"empresas",empresaId,"cotizaciones"),
            where("fecha", ">=", Timestamp.fromDate(inicioMes)),
            where("fecha", "<", Timestamp.fromDate(finMes))
          )
        );

      const docs=[]; snap.forEach(d=>docs.push({id:d.id,...d.data()}));

      cotizTotal=0; vendidoTotal=0; ventasMes=[]; let cantTotal=0, cantConfirmadas=0;
      const estadoCount={};

      docs.forEach(v=>{
        if(!v?.fecha) return;
        if(v.eliminado===true||v.estado==="Cancelada") return; // excluir eliminadas
        const f=v.fecha.toDate();
        if(f.getFullYear()===anio && f.getMonth()===mes){
          const est=v.estado||"Pendiente";
          estadoCount[est]=(estadoCount[est]||0)+1;
          if(filtroCliente && String(v.cliente||"").trim().toLowerCase()!==filtroCliente.toLowerCase()) return;
          if(filtroEstado && (v.estado||"Pendiente")!==filtroEstado) return;
          cotizTotal+=Number(v.total||0); cantTotal++;
          if(v.estado==="Convertida"){ vendidoTotal+=Number(v.total||0); ventasMes.push(v); cantConfirmadas++; }
        }
      });

      actualizarKPIs(cantTotal, cantConfirmadas);

      if(!ventasMes.length){
        [chartV,chartC,chartE].forEach(c=>{if(c)c.destroy();}); chartV=chartC=chartE=null;
        renderEstados(estadoCount);
        cargarCotizacionesMes(docs,anio,mes);
        document.body.style.cursor="default"; return;
      }

      const vpd={}, vpc={};
      ventasMes.forEach(v=>{
        const f=v.fecha.toDate?v.fecha.toDate():new Date(v.fecha);
        const dia=f.getDate();
        vpd[dia]=(vpd[dia]||0)+Number(v.total||0);
        vpc[v.cliente||"Sin cliente"]=(vpc[v.cliente||"Sin cliente"]||0)+Number(v.total||0);
      });
      const dias=Object.keys(vpd).map(Number).sort((a,b)=>a-b);

      if(chartV) chartV.destroy();
      const canvasV=$("graficoVentas"); canvasV.style.height="280px";
      const ctxV=canvasV.getContext("2d");
      chartV=new Chart(ctxV,{
        type:"bar",
        data:{
          labels:dias.map(d=>"D"+d),
          datasets:[{
            label:"Ventas",data:dias.map(d=>vpd[d]),
            backgroundColor:dias.map((_,i)=>i%2===0?P.teal:P.orange),
            borderRadius:{topLeft:6,topRight:6},borderSkipped:false,
            barPercentage:.6,categoryPercentage:.7,borderWidth:0,
            hoverBackgroundColor:P.teal3,
          }]
        },
        options:{
          responsive:true,maintainAspectRatio:false,
          plugins:{
            legend:{display:false},
            tooltip:{
              backgroundColor:P.navy,titleColor:P.teal,bodyColor:"#e2e8f0",padding:12,
              displayColors:false,
              callbacks:{title:c=>"D√≠a "+c[0].label.replace("D",""),label:c=>"Ventas: "+clp(c.raw)}
            }
          },
          scales:{
            x:{grid:{display:false},ticks:{font:{size:10,family:"Syne",weight:"700"},color:P.gray2},border:{display:false}},
            y:{beginAtZero:true,grid:{color:"rgba(255,255,255,.04)"},ticks:{font:{size:10,family:"JetBrains Mono"},color:P.gray2,callback:v=>"$"+Number(v/1000000).toFixed(1)+"M"},border:{display:false}}
          },
          animation:{duration:700,easing:"easeOutQuart"}
        }
      });

      const clsCli=Object.keys(vpc);
      if(chartC) chartC.destroy();
      if(clsCli.length){
        const canvasC=$("graficoClientes"); canvasC.style.height="270px";
        chartC=new Chart(canvasC,{
          type:"doughnut",
          data:{labels:clsCli,datasets:[{data:clsCli.map(c=>vpc[c]),backgroundColor:PALETTE,borderColor:P.navy,borderWidth:3,hoverOffset:14}]},
          options:{
            responsive:true,maintainAspectRatio:false,cutout:"70%",
            plugins:{
              legend:{position:window.innerWidth<600?"bottom":"right",labels:{boxWidth:10,padding:14,font:{size:11,family:"Syne",weight:"700"},color:"#e2e8f0",generateLabels:chart=>{return chart.data.labels.map((l,i)=>{const v=chart.data.datasets[0].data[i];return {text:l+": "+clp(v),fillStyle:chart.data.datasets[0].backgroundColor[i],strokeStyle:chart.data.datasets[0].backgroundColor[i],lineWidth:0,hidden:false,index:i};});}}},
              tooltip:{backgroundColor:P.navy,titleColor:P.teal,bodyColor:"#e2e8f0",padding:12,callbacks:{label:c=>`${c.label}: ${clp(c.raw)} (${((c.raw/vendidoTotal)*100).toFixed(1)}%)`}}
            },
            animation:{animateScale:true,duration:900},
            onClick:(evt)=>{
              const pts=chartC.getElementsAtEventForMode(evt,"nearest",{intersect:true},true);
              if(pts.length){ filtroCliente=(filtroCliente===clsCli[pts[0].index]?"":clsCli[pts[0].index]); }
              else { filtroCliente=""; }
              filtroEstado="";
              $("graficoClientes")?.parentElement?.parentElement?.classList.toggle("filtro-on",!!filtroCliente);
              $("graficoEstados")?.parentElement?.parentElement?.classList.remove("filtro-on");
              actualizarDashboard();
            }
          }
        });
      }

      renderEstados(estadoCount);
      cargarCotizacionesMes(docs,anio,mes);
      document.body.style.cursor="default";
    }

    function renderEstados(estadoCount){
      const estLabels=Object.keys(estadoCount);
      const estColors={"Convertida":P.teal,"Pendiente":P.gray,"En espera":P.amber,"Cancelada":P.red};
      if(chartE) chartE.destroy();
      if(estLabels.length){
        const canvasE=$("graficoEstados"); canvasE.style.height="270px";
        chartE=new Chart(canvasE,{
          type:"doughnut",
          data:{labels:estLabels,datasets:[{data:estLabels.map(e=>estadoCount[e]),backgroundColor:estLabels.map(e=>estColors[e]||P.gray2),borderColor:P.navy,borderWidth:3,hoverOffset:10}]},
          options:{
            responsive:true,maintainAspectRatio:false,cutout:"65%",
            plugins:{
              legend:{position:window.innerWidth<600?"bottom":"right",labels:{boxWidth:10,padding:14,font:{size:11,family:"Syne",weight:"700"},color:"#e2e8f0",generateLabels:chart=>{return chart.data.labels.map((l,i)=>{const v=chart.data.datasets[0].data[i];return {text:l+": "+v,fillStyle:chart.data.datasets[0].backgroundColor[i],strokeStyle:chart.data.datasets[0].backgroundColor[i],lineWidth:0,hidden:false,index:i};});}}},
              tooltip:{backgroundColor:P.navy,titleColor:P.orange,bodyColor:"#e2e8f0",padding:12,callbacks:{label:c=>`${c.label}: ${c.raw} cotizaciones`}}
            },
            animation:{animateScale:true,duration:800},
            onClick:(evt)=>{
              const pts=chartE.getElementsAtEventForMode(evt,"nearest",{intersect:true},true);
              if(pts.length){
                const lbl=estLabels[pts[0].index];
                filtroEstado=(filtroEstado===lbl?"":lbl);
                $("graficoEstados")?.parentElement?.parentElement?.classList.toggle("filtro-on",!!filtroEstado);
                actualizarDashboard();
              }
            }
          }
        });
      }
    }

    function cargarCotizacionesMes(docs, anio, mes){
      if(!docs){ actualizarDashboard(); return; }
      const tbody=document.querySelector("#tablaCotizaciones tbody"); if(!tbody) return;
      tbody.innerHTML="";
      docs.filter(d=>d.fecha&&d.fecha.toDate&&d.estado!=="Cancelada"&&d.eliminado!==true).forEach(d=>{
        const f=d.fecha.toDate();
        if(f.getFullYear()!==anio||f.getMonth()!==mes) return;
        const badge=d.estado==="Convertida"
          ?'<span class="badge badge-teal">Convertida</span>'
          :d.estado==="En espera"
          ?'<span class="badge badge-amber">En espera</span>'
          :'<span class="badge badge-gray">Pendiente</span>';
        tbody.innerHTML+=`<tr>
          <td class="mono" style="color:var(--teal)">${d.numero||"-"}</td>
          <td>${d.cliente||"-"}</td>
          <td style="font-size:11px;color:var(--text2)">${fmt(f)}</td>
          <td class="mono">${clp(d.total||0)}</td>
          <td>${badge}</td>
          <td style="display:flex;gap:8px;align-items:center">
            <button onclick="window.redescargarCotizacion('${d.id}')" style="background:rgba(6,214,200,.1);border:1px solid rgba(6,214,200,.2);border-radius:6px;cursor:pointer;font-size:13px;padding:4px 8px;color:var(--teal)" title="Descargar PDF">üì•</button>
            <select class="estado-sel" onchange="window.cambiarEstadoCotizacion('${d.id}',this.value)" ${d.estado==="Convertida"?"disabled":""}>
              <option value="">Seleccionar</option>
              <option value="Confirmar">‚úì Confirmar venta</option>
              <option value="En espera">‚è≥ En espera</option>
              <option value="Eliminar">‚úï Eliminar</option>
            </select>
          </td>
        </tr>`;
      });
    }

    function actualizarKPIs(cant=0, cantConf=0){
      $("kpiCotizado").textContent=clp(cotizTotal);
      $("kpiVentas").textContent=clp(vendidoTotal);
      $("kpiConversion").textContent=(cant>0?(cantConf/cant*100).toFixed(1):0)+"%";
      $("kpiCantidad").textContent=cant;
      $("kpiPromedio").textContent=cant>0?clp(cotizTotal/cant):"$ 0";
    }

    /* ‚îÄ‚îÄ LOGO ‚îÄ‚îÄ */
    $("btnUploadLogo").addEventListener("click",()=>$("logoInput").click());
    $("logoInput").addEventListener("change", async(evt)=>{
      const f=evt.target.files[0]; if(!f) return;
      const r=new FileReader(); r.onload=async()=>{
        try{
          logoB64=r.result;
          await updateDoc(doc(db,"empresas",empresaId),{logo:logoB64});
          $("logoPreview").src=logoB64; $("logoPreview").style.display="block";
          empresaData.logo=logoB64;
        }catch(e){ alert("Error: "+e.message); }
      }; r.readAsDataURL(f);
    });

    /* ‚îÄ‚îÄ BACKUP ‚îÄ‚îÄ */
    $("backupBtn").addEventListener("click", async()=>{
      if(!empresaId) return;
      const cS=await getDocs(collection(db,"empresas",empresaId,"clientes"));
      const vS=await getDocs(collection(db,"empresas",empresaId,"cotizaciones"));
      const data={clientes:cS.docs.map(d=>({id:d.id,...d.data()})),cotizaciones:vS.docs.map(d=>({id:d.id,...d.data()})),empresa:empresaData};
      const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
      const url=URL.createObjectURL(blob), a=document.createElement("a");
      a.href=url; a.download=`gestium_backup_${empresaId}_${new Date().toISOString().slice(0,10)}.json`;
      a.click(); URL.revokeObjectURL(url);
    });
    $("restoreBtn").addEventListener("click",()=>$("restoreInput").click());
    $("restoreInput").addEventListener("change", async(evt)=>{
      const f=evt.target.files[0]; if(!f) return;
      try{ JSON.parse(await f.text()); alert("Backup verificado ‚úì ‚Äî La restauraci√≥n completa requiere operaci√≥n administrativa."); }
      catch(e){ alert("Error en archivo: "+e.message); }
    });

  });
  </script>
  </body>
  </html>
