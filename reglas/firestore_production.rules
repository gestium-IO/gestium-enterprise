rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /* ============================
       UTILIDADES BASE
    ============================ */

    function isAuth() {
      return request.auth != null;
    }

    function usuarioMetaExiste() {
      return isAuth()
        && exists(/databases/$(database)/documents/usuariosMeta/$(request.auth.uid));
    }

    function perteneceAEmpresa(empresaId) {
      return usuarioMetaExiste()
        && get(/databases/$(database)/documents/usuariosMeta/$(request.auth.uid)).data.empresaId == empresaId;
    }

    function empresaExiste(empresaId) {
      return exists(/databases/$(database)/documents/empresas/$(empresaId));
    }

    function getEmpresa(empresaId) {
      return empresaExiste(empresaId)
        ? get(/databases/$(database)/documents/empresas/$(empresaId)).data
        : null;
    }

    function empresaActiva(empresaId) {
      let emp = getEmpresa(empresaId);
      return emp != null
        && (
          (('activa' in emp) && emp.activa == true)
          || (('activo' in emp) && emp.activo == true)
        )
        && (
          !('fechaVencimiento' in emp)
          || emp.fechaVencimiento > request.time
        );
    }

    function getRol(empresaId) {
      return exists(/databases/$(database)/documents/empresas/$(empresaId)/usuarios/$(request.auth.uid))
        ? get(/databases/$(database)/documents/empresas/$(empresaId)/usuarios/$(request.auth.uid)).data.rol
        : null;
    }

    function esAdmin(empresaId) {
      return perteneceAEmpresa(empresaId)
        && getRol(empresaId) == "admin";
    }

    // ✅ FIX #3: esSuperAdmin valida que el documento tenga activo == true
    function esSuperAdmin() {
      return isAuth()
        && exists(/databases/$(database)/documents/superadmin/$(request.auth.uid))
        && get(/databases/$(database)/documents/superadmin/$(request.auth.uid)).data.activo == true;
    }

    function getPlan(empresaId) {
      let emp = getEmpresa(empresaId);
      return emp != null ? emp.plan : null;
    }

    function tieneOCR(empresaId) {
      return getPlan(empresaId) in ["premium","superpremium"];
    }

    function tieneFinanciero(empresaId) {
      return getPlan(empresaId) in ["premium","superpremium"];
    }

    function tieneContabilidad(empresaId) {
      return getPlan(empresaId) == "superpremium";
    }

    // ✅ FIX #4: Función para verificar que el mes no está cerrado
    function mesNoCerrado(empresaId, mesId) {
      return !exists(/databases/$(database)/documents/empresas/$(empresaId)/cierres/$(mesId));
    }

    /* ============================
       EMPRESAS
    ============================ */

    match /empresas/{empresaId} {

      allow read:
        if (
          isAuth()
          && exists(/databases/$(database)/documents/empresas/$(empresaId)/usuarios/$(request.auth.uid))
        )
        || esSuperAdmin();

      // ✅ FIX #2: Validar que plan sea uno de los valores permitidos al crear empresa
      allow create:
        if isAuth()
        && !usuarioMetaExiste()
        && request.resource.data.keys().hasAll(['nombre','plan','activa','contador'])
        && request.resource.data.plan in ['trial','basico','premium','superpremium'];

      // ✅ FIX #1: Admin solo puede editar campos de perfil, NO plan/activa/fechaVencimiento
      allow update:
        if esSuperAdmin()
        || (
          esAdmin(empresaId)
          && request.resource.data.diff(resource.data)
               .affectedKeys()
               .hasOnly(['nombre','nit','telefono','direccion','logo','onboardingCompletado','iva'])
        );

      allow delete: if false;

      /* ============================
         USUARIOS
      ============================ */

      match /usuarios/{uid} {

        allow read:
          if (isAuth() && request.auth.uid == uid)
          || esSuperAdmin();

        allow create:
          if (esAdmin(empresaId) || esSuperAdmin())
          && request.resource.data.keys().hasAll(['email','nombre','rol','activo'])
          && request.resource.data.rol in ['admin','vendedor','contabilidad'];

        allow update:
          if esSuperAdmin()
          || esAdmin(empresaId);

        allow delete: if false;
      }

      /* ============================
         CLIENTES
      ============================ */

      match /clientes/{clienteId} {

        allow read:
          if perteneceAEmpresa(empresaId) || esSuperAdmin();

        allow create:
          if perteneceAEmpresa(empresaId)
          && empresaActiva(empresaId)
          && request.resource.data.keys().hasAll(['nombre','nombreNormalizado','creadoEn'])
          && request.resource.data.nombre is string
          && request.resource.data.creadoEn is timestamp;

        allow update:
          if perteneceAEmpresa(empresaId)
          && empresaActiva(empresaId);

        allow delete: if false;
      }

      /* ============================
         COTIZACIONES
      ============================ */

      match /cotizaciones/{cotizacionId} {

        allow read:
          if perteneceAEmpresa(empresaId) || esSuperAdmin();

        allow create:
          if perteneceAEmpresa(empresaId)
          && empresaActiva(empresaId)
          && request.resource.data.total is number
          && request.resource.data.subtotal is number
          && request.resource.data.fecha is timestamp
          && request.resource.data.estado in
             ['Pendiente','En espera','Convertida','Cancelada'];

        allow update:
          if perteneceAEmpresa(empresaId)
          && empresaActiva(empresaId)
          && request.resource.data.diff(resource.data)
               .affectedKeys()
               .hasOnly(['estado']);

        allow delete: if false;
      }

      /* ============================
         VENTAS
      ============================ */

      match /ventas/{ventaId} {

        allow read:
          if perteneceAEmpresa(empresaId) || esSuperAdmin();

        allow create:
          if perteneceAEmpresa(empresaId)
          && empresaActiva(empresaId)
          && request.resource.data.total is number
          && request.resource.data.subtotal is number
          && request.resource.data.fecha is timestamp
          && request.resource.data.estado is string
          && request.resource.data.creadoPor is string;

        allow update:
          if perteneceAEmpresa(empresaId)
          && empresaActiva(empresaId)
          && request.resource.data.diff(resource.data)
               .affectedKeys()
               .hasOnly(['estado','pagada','fechaPago','pagadoEn']);

        allow delete: if false;
      }

      /* ============================
         GASTOS
      ============================ */

      match /gastos/{gastoId} {

        allow read:
          if perteneceAEmpresa(empresaId) || esSuperAdmin();

        allow create:
          if perteneceAEmpresa(empresaId)
          && empresaActiva(empresaId)
          && tieneFinanciero(empresaId)
          && request.resource.data.valor is number
          && request.resource.data.valor > 0
          && request.resource.data.fecha is timestamp
          && request.resource.data.eliminado is bool
          && request.resource.data.creadoPor is string;

        // ✅ FIX: update de gastos también valida plan financiero
        allow update:
          if perteneceAEmpresa(empresaId)
          && empresaActiva(empresaId)
          && tieneFinanciero(empresaId);

        allow delete: if false;
      }

      /* ============================
         OCR USAGE
      ============================ */

      match /ocrUsage/{mesId} {

        allow read:
          if perteneceAEmpresa(empresaId) || esSuperAdmin();

        allow create:
          if perteneceAEmpresa(empresaId)
          && tieneOCR(empresaId)
          && request.resource.data.count == 1;

        allow update:
          if perteneceAEmpresa(empresaId)
          && tieneOCR(empresaId)
          && request.resource.data.count == resource.data.count + 1;

        allow delete: if false;
      }

      /* ============================
         CIERRE MENSUAL — FIX #4
         Bloquea asientos en meses cerrados
      ============================ */

      match /cierres/{mesId} {
        allow read:
          if perteneceAEmpresa(empresaId) || esSuperAdmin();

        // Solo admin o superadmin pueden crear un cierre
        allow create:
          if (esAdmin(empresaId) || esSuperAdmin())
          && empresaActiva(empresaId)
          && request.resource.data.keys().hasAll(['cerradoEn','cerradoPor','mes'])
          && request.resource.data.mes is string;

        // Un cierre no se puede modificar ni eliminar
        allow update, delete: if false;
      }

      /* ============================
         SALDOS MAYOR — FIX #5
         Solo Cloud Functions pueden escribir
      ============================ */

      match /saldosMayor/{mesId} {
        allow read:
          if perteneceAEmpresa(empresaId) || esSuperAdmin();

        // Solo superadmin puede escribir (simula Cloud Function con cuenta de servicio)
        allow write:
          if esSuperAdmin();
      }

    }

    /* ============================
       USUARIOS META
    ============================ */

    match /usuariosMeta/{uid} {

      allow read:
        if (isAuth() && request.auth.uid == uid)
        || esSuperAdmin();

      allow create:
        if isAuth()
        && request.auth.uid == uid
        && request.resource.data.keys().hasAll(['empresaId','email'])
        && empresaExiste(request.resource.data.empresaId);

      allow update:
        if isAuth()
        && request.auth.uid == uid
        && request.resource.data.empresaId == resource.data.empresaId;

      allow delete: if false;
    }

    /* ============================
       SUPERADMIN
    ============================ */

    match /superadmin/{uid} {
      allow read:
        if esSuperAdmin()
        || (isAuth() && request.auth.uid == uid);

      allow write: if false;
    }

    /* ============================
       LIBRO DIARIO (contabilidad)
    ============================ */

    match /empresas/{empresaId}/libroDiario/{asientoId} {
      allow read:
        if perteneceAEmpresa(empresaId) || esSuperAdmin();

      // ✅ FIX #4: Bloquear asientos si el mes está cerrado
      allow create:
        if perteneceAEmpresa(empresaId)
        && empresaActiva(empresaId)
        && tieneContabilidad(empresaId)
        && request.resource.data.cuadrado == true
        && request.resource.data.lineas is list
        && request.resource.data.lineas.size() >= 2
        && request.resource.data.mes is string
        && mesNoCerrado(empresaId, request.resource.data.mes);

      // ✅ Asientos son inmutables (soft-delete solo con campo anulado)
      allow update:
        if (esSuperAdmin()
          || esAdmin(empresaId))
        && request.resource.data.diff(resource.data)
             .affectedKeys()
             .hasOnly(['anulado','anuladoEn','anuladoPor','motivo']);

      allow delete: if false;
    }

    /* ============================
       LOGS DE EMPRESA (auditoría inmutable)
    ============================ */

    match /empresas/{empresaId}/logs/{logId} {
      allow read:
        if perteneceAEmpresa(empresaId) || esSuperAdmin();

      allow create:
        if perteneceAEmpresa(empresaId)
        && request.resource.data.fecha is timestamp;

      // ✅ Logs son inmutables
      allow update, delete: if false;
    }

    /* ============================
       INVITACIONES
    ============================ */

    match /empresas/{empresaId}/invitaciones/{invId} {
      allow read:
        if perteneceAEmpresa(empresaId) || esSuperAdmin();

      allow create:
        if esAdmin(empresaId)
        && empresaActiva(empresaId)
        && request.resource.data.token is string
        && request.resource.data.expira is timestamp;

      allow update:
        if isAuth()
        && request.resource.data.diff(resource.data)
             .affectedKeys()
             .hasOnly(['usada','usadaEn']);

      allow delete: if false;
    }

    /* ============================
       ALERTAS CONTABLES
    ============================ */

    match /empresas/{empresaId}/alertasContables/{alertaId} {
      allow read:
        if perteneceAEmpresa(empresaId) || esSuperAdmin();

      allow create:
        if perteneceAEmpresa(empresaId)
        && tieneContabilidad(empresaId);

      allow update, delete: if false;
    }

    /* ============================
       ERRORES GLOBALES (centralizados)
    ============================ */

    match /errores/{errorId} {
      allow read: if esSuperAdmin();

      allow create: if isAuth();

      allow update, delete: if false;
    }

    /* ============================
       MÉTRICAS SAAS (solo superadmin)
    ============================ */

    match /metricasSaas/{fecha} {
      allow read, write: if esSuperAdmin();
    }

    /* ============================
       BLOQUEO TOTAL
    ============================ */

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
