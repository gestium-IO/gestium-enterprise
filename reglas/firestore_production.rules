rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /* ============================
       UTILIDADES BASE
    ============================ */

    function isAuth() {
      return request.auth != null;
    }

    function usuarioMetaExiste() {
      return isAuth()
        && exists(/databases/$(database)/documents/usuariosMeta/$(request.auth.uid));
    }

    function perteneceAEmpresa(empresaId) {
      return usuarioMetaExiste()
        && get(/databases/$(database)/documents/usuariosMeta/$(request.auth.uid)).data.empresaId == empresaId;
    }

    function empresaExiste(empresaId) {
      return exists(/databases/$(database)/documents/empresas/$(empresaId));
    }

    function getEmpresa(empresaId) {
      return empresaExiste(empresaId)
        ? get(/databases/$(database)/documents/empresas/$(empresaId)).data
        : null;
    }

    function empresaActiva(empresaId) {
      let emp = getEmpresa(empresaId);
      return emp != null
        && (
          (('activa' in emp) && emp.activa == true)
          || (('activo' in emp) && emp.activo == true)
        )
        && (
          !('fechaVencimiento' in emp)
          || emp.fechaVencimiento > request.time
        );
    }

    function getRol(empresaId) {
      return exists(/databases/$(database)/documents/empresas/$(empresaId)/usuarios/$(request.auth.uid))
        ? get(/databases/$(database)/documents/empresas/$(empresaId)/usuarios/$(request.auth.uid)).data.rol
        : null;
    }

    function esAdmin(empresaId) {
      return perteneceAEmpresa(empresaId)
        && getRol(empresaId) == "admin";
    }

    function esSuperAdmin() {
      return isAuth()
        && exists(/databases/$(database)/documents/superadmin/$(request.auth.uid));
    }

    function getPlan(empresaId) {
      let emp = getEmpresa(empresaId);
      return emp != null ? emp.plan : null;
    }

    function tieneOCR(empresaId) {
      return getPlan(empresaId) in ["premium","superpremium"];
    }

    function tieneFinanciero(empresaId) {
      return getPlan(empresaId) in ["premium","superpremium"];
    }

    function tieneContabilidad(empresaId) {
      return getPlan(empresaId) == "superpremium";
    }

    /* ============================
       EMPRESAS
    ============================ */

    match /empresas/{empresaId} {

      allow read:
        if (
          isAuth()
          && exists(/databases/$(database)/documents/empresas/$(empresaId)/usuarios/$(request.auth.uid))
        )
        || esSuperAdmin();

      allow create:
        if isAuth()
        && !usuarioMetaExiste()
        && request.resource.data.keys().hasAll(['nombre','plan','activa','contador'])
        && request.resource.data.plan in ['trial','basico','premium','superpremium'];

      allow update:
        if esSuperAdmin()
        || esAdmin(empresaId);

      allow delete: if false;

      /* ============================
         USUARIOS
      ============================ */

      match /usuarios/{uid} {

        allow read:
          if (isAuth() && request.auth.uid == uid)
          || esSuperAdmin();

        allow create:
          if (esAdmin(empresaId) || esSuperAdmin())
          && request.resource.data.keys().hasAll(['email','nombre','rol','activo'])
          && request.resource.data.rol in ['admin','vendedor','contabilidad'];

        allow update:
          if esSuperAdmin()
          || esAdmin(empresaId);

        allow delete: if false;
      }

      /* ============================
         CLIENTES
      ============================ */

      match /clientes/{clienteId} {

        allow read:
          if perteneceAEmpresa(empresaId) || esSuperAdmin();

        allow create:
          if perteneceAEmpresa(empresaId)
          && empresaActiva(empresaId)
          && request.resource.data.keys().hasAll(['nombre','nombreNormalizado','creadoEn'])
          && request.resource.data.nombre is string
          && request.resource.data.creadoEn is timestamp;

        allow update:
          if perteneceAEmpresa(empresaId)
          && empresaActiva(empresaId);

        allow delete: if false;
      }

      /* ============================
         COTIZACIONES
      ============================ */

      match /cotizaciones/{cotizacionId} {

        allow read:
          if perteneceAEmpresa(empresaId) || esSuperAdmin();

        allow create:
          if perteneceAEmpresa(empresaId)
          && empresaActiva(empresaId)
          && request.resource.data.total is number
          && request.resource.data.subtotal is number
          && request.resource.data.fecha is timestamp
          && request.resource.data.estado in
             ['Pendiente','En espera','Convertida','Cancelada'];

        allow update:
          if perteneceAEmpresa(empresaId)
          && empresaActiva(empresaId)
          && request.resource.data.diff(resource.data)
               .affectedKeys()
               .hasOnly(['estado']);

        allow delete: if false;
      }

      /* ============================
         VENTAS
      ============================ */

      match /ventas/{ventaId} {

        allow read:
          if perteneceAEmpresa(empresaId) || esSuperAdmin();

        allow create:
          if perteneceAEmpresa(empresaId)
          && empresaActiva(empresaId)
          && request.resource.data.total is number
          && request.resource.data.fecha is timestamp;

        allow delete: if false;
      }

      /* ============================
         GASTOS
      ============================ */

      match /gastos/{gastoId} {

        allow read:
          if perteneceAEmpresa(empresaId) || esSuperAdmin();

        allow create:
          if perteneceAEmpresa(empresaId)
          && empresaActiva(empresaId)
          && request.resource.data.valor is number
          && request.resource.data.fecha is timestamp;

        allow update:
          if perteneceAEmpresa(empresaId)
          && empresaActiva(empresaId);

        allow delete: if false;
      }

      /* ============================
         OCR USAGE
      ============================ */

      match /ocrUsage/{mesId} {

        allow read:
          if perteneceAEmpresa(empresaId) || esSuperAdmin();

        allow create:
          if perteneceAEmpresa(empresaId)
          && tieneOCR(empresaId)
          && request.resource.data.count == 1;

        allow update:
          if perteneceAEmpresa(empresaId)
          && tieneOCR(empresaId)
          && request.resource.data.count == resource.data.count + 1;

        allow delete: if false;
      }

    }

    /* ============================
       USUARIOS META
    ============================ */

    match /usuariosMeta/{uid} {

      allow read:
        if (isAuth() && request.auth.uid == uid)
        || esSuperAdmin();

      allow create:
        if isAuth()
        && request.auth.uid == uid
        && request.resource.data.keys().hasAll(['empresaId','email'])
        && empresaExiste(request.resource.data.empresaId);

      allow update:
        if isAuth()
        && request.auth.uid == uid
        && request.resource.data.empresaId == resource.data.empresaId;

      allow delete: if false;
    }

    /* ============================
       SUPERADMIN
    ============================ */

    match /superadmin/{uid} {
      allow read:
        if esSuperAdmin()
        || (isAuth() && request.auth.uid == uid);

      allow write: if false;
    }

    /* ============================
       BLOQUEO TOTAL
    ============================ */

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
