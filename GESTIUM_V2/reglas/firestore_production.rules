rules_version = '2';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GESTIUM Â· Reglas Firestore ProducciÃ³n
//  SaaS Robusto 5 AÃ±os Â· Multiempresa Â· Control de Planes
//
//  ğŸ”´ COPIAR EXACTAMENTE ESTAS REGLAS EN FIREBASE CONSOLE
//  Firebase Console â†’ Firestore Database â†’ Rules â†’ Publicar
//
//  Precios: BÃ¡sico $65k Â· Premium $119k Â· SuperPremium $229k COP/mes
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

service cloud.firestore {
  match /databases/{database}/documents {

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       FUNCIONES BASE - ARQUITECTURA MULTIEMPRESA
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    function isAuth() {
      return request.auth != null;
    }

    function empresaDoc(empresaId) {
      return /databases/$(database)/documents/empresas/$(empresaId);
    }

    function userDoc(empresaId) {
      return /databases/$(database)/documents/empresas/$(empresaId)/usuarios/$(request.auth.uid);
    }

    function perteneceAEmpresa(empresaId) {
      return isAuth() && exists(userDoc(empresaId));
    }

    function getEmpresa(empresaId) {
      return get(empresaDoc(empresaId)).data;
    }

    // ğŸ”´ CRÃTICO: Empresa activa + no vencida
    function empresaActiva(empresaId) {
      return getEmpresa(empresaId).activa == true
        && getEmpresa(empresaId).fechaVencimiento > request.time;
    }

    function getRol(empresaId) {
      return get(userDoc(empresaId)).data.rol;
    }

    function esAdmin(empresaId) {
      return perteneceAEmpresa(empresaId)
        && getRol(empresaId) == "admin";
    }

    function esContabilidad(empresaId) {
      return perteneceAEmpresa(empresaId)
        && (getRol(empresaId) == "admin" || getRol(empresaId) == "contabilidad");
    }

    function getPlan(empresaId) {
      return getEmpresa(empresaId).plan;
    }

    function tieneFinanciero(empresaId) {
      return getPlan(empresaId) in ["premium","superpremium"];
    }

    function tieneContabilidad(empresaId) {
      return getPlan(empresaId) == "superpremium";
    }

    function esSuperAdmin() {
      return isAuth() &&
        exists(/databases/$(database)/documents/superadmin/$(request.auth.uid));
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       EMPRESAS - Nunca se pueden eliminar
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    match /empresas/{empresaId} {

      // Leer: solo miembros de la empresa
      allow read: if perteneceAEmpresa(empresaId);

      // Crear: solo durante registro (primera vez)
      // Validar estructura mÃ­nima obligatoria
      allow create: if isAuth() &&
        request.resource.data.keys().hasAll(['nombre', 'plan', 'activa', 'fechaVencimiento', 'contador']) &&
        request.resource.data.plan in ['trial', 'basico', 'premium', 'superpremium'] &&
        request.resource.data.activa == true;

      // Actualizar: solo admin (NO puede cambiar plan desde frontend)
      allow update: if esAdmin(empresaId) &&
        // ğŸ”´ CRÃTICO: Plan NO se puede cambiar desde frontend
        request.resource.data.plan == resource.data.plan;

      // ğŸ”´ CRÃTICO: Nunca eliminar empresas (soft delete con activa:false)
      allow delete: if false;

      /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         USUARIOS (subcolecciÃ³n por empresa)
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

      match /usuarios/{uid} {

        allow read: if perteneceAEmpresa(empresaId);

        // Crear: admin o durante registro (primera vez)
        allow create: if (esAdmin(empresaId) || request.auth.uid == uid) &&
          request.resource.data.keys().hasAll(['email', 'nombre', 'rol', 'activo']) &&
          request.resource.data.rol in ['admin', 'vendedor', 'contabilidad'];

        // Actualizar: solo admin
        allow update: if esAdmin(empresaId);

        // ğŸ”´ CRÃTICO: Nunca eliminar usuarios (soft delete con activo:false)
        allow delete: if false;
      }

      /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         CLIENTES
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

      match /clientes/{clienteId} {

        allow read: if perteneceAEmpresa(empresaId);

        allow create: if perteneceAEmpresa(empresaId) &&
          empresaActiva(empresaId) &&
          request.resource.data.keys().hasAll(['nombre', 'nombreNormalizado', 'creadoEn']);

        allow update: if perteneceAEmpresa(empresaId) && empresaActiva(empresaId);

        // Soft delete solamente
        allow delete: if false;
      }

      /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         COTIZACIONES - ValidaciÃ³n estricta
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

      match /cotizaciones/{cotizacionId} {

        allow read: if perteneceAEmpresa(empresaId);

        allow create: if perteneceAEmpresa(empresaId) &&
          empresaActiva(empresaId) &&
          request.resource.data.keys().hasAll([
            'numero', 'cliente', 'fecha', 'subtotal', 'iva', 'total',
            'estado', 'eliminado'
          ]) &&
          request.resource.data.eliminado == false &&
          request.resource.data.estado in ['Pendiente', 'En espera', 'Convertida', 'Cancelada'] &&
          // ğŸ”´ CRÃTICO: Validar montos son nÃºmeros, no strings
          request.resource.data.total is number &&
          request.resource.data.subtotal is number &&
          request.resource.data.iva is number;

        allow update: if perteneceAEmpresa(empresaId) &&
          empresaActiva(empresaId) &&
          // No se puede cambiar el nÃºmero de cotizaciÃ³n
          request.resource.data.numero == resource.data.numero;

        // Soft delete solamente
        allow delete: if false;
      }

      /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         GASTOS - Solo planes Premium y SuperPremium
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

      match /gastos/{gastoId} {

        allow read: if perteneceAEmpresa(empresaId) &&
          tieneFinanciero(empresaId);

        allow create: if perteneceAEmpresa(empresaId) &&
          tieneFinanciero(empresaId) &&
          empresaActiva(empresaId) &&
          request.resource.data.keys().hasAll(['fecha', 'categoria', 'valor']) &&
          request.resource.data.valor is number;

        allow update: if perteneceAEmpresa(empresaId) &&
          tieneFinanciero(empresaId) &&
          empresaActiva(empresaId);

        allow delete: if false;
      }

      /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         LIBRO DIARIO - Solo SuperPremium
         ğŸ”´ CRÃTICO: ValidaciÃ³n de doble partida en reglas
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

      match /libroDiario/{asientoId} {

        // Leer: solo plan SuperPremium
        allow read: if perteneceAEmpresa(empresaId) &&
          tieneContabilidad(empresaId);

        // Crear: validar doble partida y estructura completa
        allow create: if esContabilidad(empresaId) &&
          tieneContabilidad(empresaId) &&
          empresaActiva(empresaId) &&
          // ğŸ”´ Estructura obligatoria
          request.resource.data.keys().hasAll([
            'fecha', 'tipo', 'descripcion', 'lineas', 'total',
            'cuadrado', 'creadoEn', 'creadoPor', 'origenTipo', 'origenId'
          ]) &&
          // ğŸ”´ CRÃTICO: Debe estar cuadrado
          request.resource.data.cuadrado == true &&
          // ğŸ”´ Debe tener al menos 2 lÃ­neas (dÃ©bito y crÃ©dito)
          request.resource.data.lineas is list &&
          request.resource.data.lineas.size() >= 2 &&
          // Fecha debe ser timestamp
          request.resource.data.fecha is timestamp &&
          // Usuario que creÃ³
          request.resource.data.creadoPor == request.auth.uid &&
          // Total debe ser nÃºmero
          request.resource.data.total is number;

        // ğŸ”´ CRÃTICO: Asientos NUNCA se modifican
        // Solo se puede marcar como anulado
        allow update: if esAdmin(empresaId) &&
          tieneContabilidad(empresaId) &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['anulado', 'anuladoPor', 'anuladoEn']);

        // ğŸ”´ CRÃTICO: NUNCA eliminar asientos histÃ³ricos
        allow delete: if false;
      }

      /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         ALERTAS CONTABLES - Solo lectura para usuarios
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

      match /alertasContables/{alertaId} {

        allow read: if perteneceAEmpresa(empresaId) &&
          tieneContabilidad(empresaId);

        // Solo el sistema puede crear (desde backend)
        allow create: if esContabilidad(empresaId) &&
          tieneContabilidad(empresaId);

        // No se pueden modificar ni eliminar
        allow update, delete: if false;
      }

      /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         LOGS - Inmutables, solo admin puede leer
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

      match /logs/{logId} {

        // Leer: solo admins
        allow read: if esAdmin(empresaId);

        // Crear: cualquier usuario activo (auto-log)
        allow create: if perteneceAEmpresa(empresaId) &&
          request.resource.data.keys().hasAll(['accion', 'usuario', 'fecha']) &&
          request.resource.data.usuario == request.auth.uid;

        // ğŸ”´ CRÃTICO: Logs son inmutables
        allow update, delete: if false;
      }

      /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         INVITACIONES - Control de acceso a empresa
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

      match /invitaciones/{invitacionId} {

        allow read: if perteneceAEmpresa(empresaId) ||
          // Usuario invitado puede leer su propia invitaciÃ³n
          resource.data.email == request.auth.token.email;

        allow create: if esAdmin(empresaId) &&
          empresaActiva(empresaId) &&
          request.resource.data.keys().hasAll(['email', 'rol', 'creadoEn', 'token', 'expiraEn']) &&
          // Token Ãºnico para evitar reutilizaciÃ³n
          request.resource.data.token is string &&
          // ExpiraciÃ³n obligatoria (7 dÃ­as)
          request.resource.data.expiraEn is timestamp;

        allow update: if esAdmin(empresaId);

        allow delete: if esAdmin(empresaId);
      }

      /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         PERIODOS CERRADOS - Control contable
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

      match /periodosCerrados/{periodoId} {

        allow read: if perteneceAEmpresa(empresaId) &&
          tieneContabilidad(empresaId);

        // Solo admin puede cerrar periodos
        allow create: if esAdmin(empresaId) &&
          tieneContabilidad(empresaId) &&
          request.resource.data.keys().hasAll(['mes', 'anio', 'cerradoEn', 'cerradoPor']);

        // Periodo cerrado no se puede modificar ni eliminar
        allow update, delete: if false;
      }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       USUARIOS META - Bootstrap de login (solo empresaId)
       Permite que auth encuentre la empresa del usuario al iniciar sesiÃ³n
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    match /usuariosMeta/{uid} {
      // Solo el propio usuario puede leer su meta
      allow read: if isAuth() && request.auth.uid == uid;

      // Solo el propio usuario puede crear/actualizar su meta
      allow create, update: if isAuth() && request.auth.uid == uid &&
        request.resource.data.keys().hasAll(['empresaId', 'email']) &&
        request.resource.data.empresaId is string;

      // Nunca eliminar
      allow delete: if false;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SUPERADMIN GLOBAL - Control total del sistema
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    match /superadmin/{uid} {
      // Solo superadmins pueden acceder
      allow read, write: if esSuperAdmin();
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MÃ‰TRICAS SAAS - Dashboard interno
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    match /metricasSaas/{metricaId} {
      // Solo superadmins
      allow read, write: if esSuperAdmin();
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PAGOS - Historial de facturaciÃ³n
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    match /pagos/{pagoId} {
      // Leer: usuario de la empresa o superadmin
      allow read: if (resource.data.empresaId != null &&
        perteneceAEmpresa(resource.data.empresaId)) ||
        esSuperAdmin();

      // Crear: solo superadmin (desde webhook de pago)
      allow create, update: if esSuperAdmin();

      // Nunca eliminar historial de pagos
      allow delete: if false;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       BLOQUEO GLOBAL - Todo lo no especificado estÃ¡ bloqueado
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
