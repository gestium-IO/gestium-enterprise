<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GESTIUM ¬∑ B√°sico ¬∑ Inteligencia Operativa</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<style>
:root{
  --navy:   #070d1a;--navy2:#0d1629;--navy3:#111e35;--navy4:#1a2a45;
  --orange: #f97316;--orange2:#fb923c;
  --teal:   #06d6c8;--teal2:#22d3ee;--teal3:#67e8f9;
  --text:   #e2e8f0;--text2:#94a3b8;--text3:#64748b;
  --white:  #ffffff;--red:#ef4444;--amber:#f59e0b;--green:#10b981;
  --r:10px;--r2:16px;--shadow:0 4px 24px rgba(0,0,0,.4);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Syne',system-ui,sans-serif;background:var(--navy);color:var(--text);-webkit-font-smoothing:antialiased;min-height:100vh}
body::after{content:'GESTIUM';position:fixed;bottom:50%;right:-60px;font-size:110px;font-weight:800;letter-spacing:8px;color:rgba(249,115,22,.03);transform:rotate(-90deg) translateY(50%);pointer-events:none;z-index:0;white-space:nowrap;}

/* LOGIN */
#loginScreen{display:flex;min-height:100vh;background:var(--navy);overflow:hidden;position:relative}
#loginScreen::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at 15% 50%,rgba(6,214,200,.12) 0%,transparent 55%),radial-gradient(ellipse at 85% 20%,rgba(249,115,22,.14) 0%,transparent 50%);pointer-events:none}
.login-grid-bg{position:absolute;inset:0;background-image:linear-gradient(rgba(6,214,200,.04) 1px,transparent 1px),linear-gradient(90deg,rgba(6,214,200,.04) 1px,transparent 1px);background-size:60px 60px;pointer-events:none}
.login-deco{flex:1;display:flex;flex-direction:column;justify-content:center;padding:72px;position:relative;z-index:1}
.login-eyebrow{font-size:10px;font-weight:700;letter-spacing:4px;text-transform:uppercase;color:var(--teal);margin-bottom:22px;display:flex;align-items:center;gap:10px}
.login-eyebrow::before{content:'';width:32px;height:2px;background:var(--teal)}
.login-headline{font-size:clamp(30px,4vw,52px);font-weight:800;line-height:1.05;color:var(--white);margin-bottom:20px;letter-spacing:-1px}
.login-headline em{color:var(--orange);font-style:normal;text-shadow:0 0 40px rgba(249,115,22,.4)}
.login-tagline{font-size:15px;color:var(--text2);line-height:1.7;max-width:360px}
.login-chips{display:flex;gap:10px;flex-wrap:wrap;margin-top:44px}
.login-chip{padding:7px 16px;border-radius:100px;border:1px solid rgba(6,214,200,.2);color:var(--teal3);font-size:11px;font-weight:600;background:rgba(6,214,200,.05)}
.login-panel{width:440px;min-height:100vh;background:var(--navy2);display:flex;flex-direction:column;justify-content:center;padding:60px 48px;position:relative;z-index:1;border-left:1px solid rgba(6,214,200,.08)}
.login-panel::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--teal),var(--orange))}
.login-logo-text{font-size:22px;font-weight:800;color:var(--white);letter-spacing:2px;margin-bottom:4px}
.login-logo-text span{color:var(--orange)}
.login-sub-text{font-size:11px;color:var(--teal);letter-spacing:2px;text-transform:uppercase;font-weight:600;margin-bottom:36px}
.f-label{display:block;font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--text3);margin-bottom:7px}
.f-input{width:100%;padding:12px 16px;border-radius:var(--r);border:1.5px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);font-family:inherit;font-size:14px;color:var(--text);outline:none;transition:border-color .2s,box-shadow .2s}
.f-input:focus{border-color:var(--teal);box-shadow:0 0 0 3px rgba(6,214,200,.12)}
.f-input::placeholder{color:var(--text3)}
.pw-wrap{position:relative}.pw-wrap .f-input{padding-right:44px}
.pw-eye{position:absolute;right:14px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:14px;opacity:.4;transition:opacity .2s}
.pw-eye:hover{opacity:1}
.login-row{display:flex;justify-content:space-between;align-items:center;margin:12px 0 22px}
.rem-label{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text2);cursor:pointer}
.rem-label input{accent-color:var(--teal);width:14px;height:14px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;cursor:pointer;border:none;font-family:inherit;font-size:14px;font-weight:700;border-radius:var(--r);padding:13px 22px;transition:transform .14s,box-shadow .14s;letter-spacing:.3px}
.btn:active{transform:scale(.97)}
.btn-primary{background:linear-gradient(135deg,var(--teal),var(--orange));color:#fff;box-shadow:0 4px 20px rgba(249,115,22,.25);width:100%}
.btn-primary:hover{box-shadow:0 6px 30px rgba(249,115,22,.4)}
.btn-ghost{background:none;color:var(--teal);font-size:12px;padding:5px 0;font-weight:600}
.btn-sm{padding:8px 16px;font-size:12px;border-radius:8px}
.btn-navy{background:var(--navy4);color:var(--text);border:1px solid rgba(255,255,255,.08)}
.btn-teal{background:rgba(6,214,200,.12);color:var(--teal);border:1px solid rgba(6,214,200,.2)}
.btn-orange{background:rgba(249,115,22,.15);color:var(--orange);border:1px solid rgba(249,115,22,.2)}
.login-msg{min-height:18px;font-size:12px;color:var(--red);text-align:center;margin-top:12px}
.login-footer{text-align:center;margin-top:24px;font-size:12px;color:var(--text3)}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
.shake{animation:shake .3s ease}
.input-error{border-color:var(--red)!important;box-shadow:0 0 0 3px rgba(239,68,68,.1)!important}
@media(max-width:800px){.login-deco{display:none}.login-panel{width:100%;padding:40px 24px}}

/* REGISTRO */
#registerScreen{display:none;min-height:100vh;background:var(--navy);align-items:flex-start;justify-content:center;padding:48px 20px;overflow-y:auto;position:relative}
#registerScreen::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at 30% 40%,rgba(6,214,200,.08) 0%,transparent 50%),radial-gradient(ellipse at 70% 70%,rgba(249,115,22,.08) 0%,transparent 50%);pointer-events:none}
.reg-card{width:560px;max-width:100%;background:var(--navy2);border-radius:var(--r2);box-shadow:0 8px 40px rgba(0,0,0,.5);border:1px solid rgba(6,214,200,.1);overflow:hidden;position:relative;z-index:1}
@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
.fade-up{animation:fadeUp .35s ease both}
.reg-head{background:linear-gradient(135deg,var(--navy3),var(--navy4));padding:32px 40px 28px;border-bottom:1px solid rgba(6,214,200,.1);position:relative;overflow:hidden}
.reg-head::after{content:'';position:absolute;top:-30px;right:-30px;width:120px;height:120px;border-radius:50%;background:radial-gradient(circle,rgba(249,115,22,.15),transparent)}
.reg-head h2{font-size:22px;font-weight:800;color:var(--white);margin-bottom:4px;position:relative;z-index:1}
.reg-head p{font-size:12px;color:var(--text3);position:relative;z-index:1}
.reg-body{padding:30px 40px 40px}
.reg-sep{display:flex;align-items:center;gap:10px;font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--teal);margin:24px 0 14px}
.reg-sep::before,.reg-sep::after{content:'';flex:1;height:1px;background:rgba(6,214,200,.15)}
.reg-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:500px){.reg-2{grid-template-columns:1fr}}
.ri{width:100%;padding:11px 14px;border-radius:8px;border:1.5px solid rgba(255,255,255,.07);background:rgba(255,255,255,.03);font-family:inherit;font-size:13px;color:var(--text);outline:none;transition:border-color .2s,box-shadow .2s;margin-bottom:8px}
.ri::placeholder{color:var(--text3)}
.ri:focus{border-color:var(--teal);box-shadow:0 0 0 3px rgba(6,214,200,.1)}
.reg-msg{min-height:18px;font-size:12px;color:var(--red);text-align:center;margin-top:8px}
.mode-tgl{display:flex;border-radius:8px;overflow:hidden;border:1.5px solid rgba(255,255,255,.08);margin-bottom:20px}
.mode-btn{flex:1;padding:10px 14px;background:transparent;border:none;font-family:inherit;font-size:12px;font-weight:700;color:var(--text3);cursor:pointer;transition:background .15s,color .15s}
.mode-btn.on{background:var(--navy4);color:var(--teal)}

/* APP */
#app{display:none}
.sidebar{position:fixed;left:0;top:0;width:256px;height:100vh;background:var(--navy2);display:flex;flex-direction:column;z-index:200;border-right:1px solid rgba(6,214,200,.06)}
.sb-stripe{height:3px;background:linear-gradient(90deg,var(--teal),var(--orange))}
.sb-top{padding:24px 20px 16px;border-bottom:1px solid rgba(255,255,255,.04)}
.sb-brand{font-size:9px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(--teal);margin-bottom:8px;display:flex;align-items:center;gap:8px}
.sb-brand::before{content:'';width:20px;height:1px;background:var(--teal)}
.sb-company{font-size:15px;font-weight:800;color:var(--white);word-break:break-word;line-height:1.3}
.sb-nav{flex:1;padding:16px 10px;display:flex;flex-direction:column;gap:2px}
.sb-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;background:none;border:none;color:var(--text2);font-family:inherit;font-size:13px;font-weight:600;cursor:pointer;text-align:left;transition:background .15s,color .15s;width:100%}
.sb-item:hover{background:rgba(255,255,255,.04);color:var(--text)}
.sb-item.active{background:rgba(6,214,200,.08);color:var(--teal)}
.sb-dot{width:6px;height:6px;border-radius:50%;background:var(--text3);flex-shrink:0;transition:background .15s}
.sb-item.active .sb-dot{background:var(--teal)}
.sb-footer{padding:16px 10px;border-top:1px solid rgba(255,255,255,.04)}
.user-pill{display:flex;align-items:center;gap:10px;padding:12px;border-radius:10px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.05);margin-bottom:10px}
.user-av{width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,var(--teal),var(--orange));display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:800;color:#fff;flex-shrink:0}
.user-info{min-width:0}
.user-name{font-size:12px;font-weight:700;color:var(--white);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.user-email{font-size:10px;color:var(--text3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.btn-logout{width:100%;padding:10px;border-radius:8px;background:none;border:1px solid rgba(239,68,68,.15);color:rgba(239,68,68,.6);font-family:inherit;font-size:12px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:7px;transition:background .15s,color .15s}
.btn-logout:hover{background:rgba(239,68,68,.08);color:var(--red)}
.main{margin-left:256px;min-height:100vh;background:var(--navy)}
.topbar{background:var(--navy2);border-bottom:1px solid rgba(6,214,200,.06);padding:0 36px;height:62px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.topbar-title{font-size:15px;font-weight:800;color:var(--white);letter-spacing:.5px}
.topbar-badge{font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--orange);background:rgba(249,115,22,.1);padding:3px 10px;border-radius:100px;border:1px solid rgba(249,115,22,.2)}
#menuToggle{display:none;background:none;border:none;cursor:pointer;color:var(--text);font-size:20px;padding:4px 8px;margin-right:10px}
.page{padding:32px 36px}
.card{background:var(--navy2);border-radius:var(--r2);border:1px solid rgba(255,255,255,.05);box-shadow:0 2px 16px rgba(0,0,0,.3)}
.card-body{padding:24px}
.card-title{font-size:14px;font-weight:700;color:var(--text);margin-bottom:16px;display:flex;align-items:center;gap:8px;letter-spacing:.3px}
.kpi-row{display:flex;gap:14px;margin-bottom:24px;flex-wrap:wrap}
.kpi{flex:1;min-width:150px;background:var(--navy2);border-radius:var(--r2);padding:18px 20px;border:1px solid rgba(255,255,255,.05);position:relative;overflow:hidden;transition:transform .2s,border-color .2s}
.kpi:hover{transform:translateY(-2px);border-color:rgba(6,214,200,.15)}
.kpi::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;border-radius:3px 0 0 3px}
.kpi.k-teal::before{background:var(--teal)}.kpi.k-orange::before{background:var(--orange)}.kpi.k-amber::before{background:var(--amber)}.kpi.k-gray::before{background:var(--text3)}
.kpi-lbl{font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);margin-bottom:6px}
.kpi-val{font-size:18px;font-weight:700;color:var(--white);font-family:'JetBrains Mono',monospace;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.kpi-val.pos{color:var(--teal)}
.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}
.chart-box{background:var(--navy2);border-radius:var(--r2);border:1px solid rgba(255,255,255,.05);padding:22px;position:relative}
.chart-box-full{grid-column:1/-1}
.chart-label{font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);margin-bottom:18px;display:flex;align-items:center;gap:10px}
.chart-label span{color:var(--teal)}
.chart-label::after{content:'';flex:1;height:1px;background:rgba(255,255,255,.05)}
.chart-container{position:relative;width:100%}
@media(max-width:900px){.charts-grid{grid-template-columns:1fr}.chart-box-full{grid-column:auto}}
.tbl-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
table{width:100%;border-collapse:collapse;min-width:560px}
thead{background:rgba(6,214,200,.04);border-bottom:1px solid rgba(6,214,200,.1)}
th{padding:12px 16px;text-align:left;font-size:9px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--teal);white-space:nowrap}
td{padding:12px 16px;font-size:13px;border-bottom:1px solid rgba(255,255,255,.04);color:var(--text)}
tr:hover td{background:rgba(255,255,255,.02)}
.f-lbl{display:block;font-size:10px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;color:var(--text3);margin-bottom:7px}
.inp{width:100%;padding:11px 14px;border-radius:var(--r);border:1.5px solid rgba(255,255,255,.07);background:rgba(255,255,255,.03);font-family:inherit;font-size:13px;color:var(--text);outline:none;transition:border-color .2s,box-shadow .2s}
.inp::placeholder{color:var(--text3)}
.inp:focus{border-color:var(--teal);box-shadow:0 0 0 3px rgba(6,214,200,.08)}
.badge{display:inline-flex;align-items:center;padding:4px 12px;border-radius:100px;font-size:10px;font-weight:700;letter-spacing:.5px}
.badge-teal{background:rgba(6,214,200,.12);color:var(--teal);border:1px solid rgba(6,214,200,.2)}
.badge-amber{background:rgba(245,158,11,.1);color:var(--amber);border:1px solid rgba(245,158,11,.2)}
.badge-gray{background:rgba(100,116,139,.1);color:var(--text2);border:1px solid rgba(100,116,139,.2)}
.estado-sel{padding:7px 12px;border-radius:8px;border:1.5px solid rgba(255,255,255,.07);background:var(--navy3);font-family:inherit;font-size:11px;font-weight:700;color:var(--text);cursor:pointer;min-width:140px}
.estado-sel:focus{outline:none;border-color:var(--teal)}
.sec-title{font-size:20px;font-weight:800;color:var(--white);margin-bottom:24px;display:flex;align-items:center;gap:14px;letter-spacing:-.3px}
.sec-title-tag{font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--orange);background:rgba(249,115,22,.1);padding:4px 12px;border-radius:100px;border:1px solid rgba(249,115,22,.2)}
.sec-title::after{content:'';flex:1;height:1px;background:rgba(255,255,255,.05)}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);opacity:0;pointer-events:none;transition:opacity .3s;z-index:150}
.overlay.on{opacity:1;pointer-events:auto}
.logo-preview{max-width:110px;border-radius:8px;margin-top:10px;display:block}
.filtro-on{box-shadow:0 0 0 2px var(--teal)!important}
.mono{font-family:'JetBrains Mono',monospace}
.filter-bar{background:var(--navy2);border-radius:var(--r2);border:1px solid rgba(255,255,255,.05);padding:16px 22px;margin-bottom:22px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.inp-row{display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end}
@keyframes pulse-dot{0%,100%{opacity:1}50%{opacity:.4}}
.live-dot{display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--teal);animation:pulse-dot 2s ease infinite}
@media(max-width:768px){#menuToggle{display:block}.sidebar{left:-265px;transition:left .3s}.sidebar.open{left:0}.main{margin-left:0}.topbar{padding:0 16px}.page{padding:20px 14px}.kpi-row{gap:8px}.kpi{min-width:calc(50% - 4px);padding:14px}}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="login-grid-bg"></div>
  <div class="login-deco">
    <div class="login-eyebrow">GESTIUM ¬∑ Plan B√°sico</div>
    <div class="login-headline">Tus<br><em>cotizaciones</em><br>bajo control.</div>
    <div class="login-tagline">Genera, rastrea y gestiona tus cotizaciones con facilidad. Todo en la nube, en tiempo real.</div>
    <div class="login-chips">
      <div class="login-chip">üìÑ PDF autom√°tico</div>
      <div class="login-chip">üìä Dashboard en vivo</div>
      <div class="login-chip">‚òÅÔ∏è 100% en la nube</div>
    </div>
    <div style="display:flex;gap:10px;justify-content:center;margin-top:24px;flex-wrap:wrap">
      <a href="https://www.facebook.com/share/18DSCn8qA3/" target="_blank" rel="noopener noreferrer" style="color:var(--text3);font-size:11px;text-decoration:none;display:flex;align-items:center;gap:4px">üìò Facebook</a>
      <a href="https://www.instagram.com/gestium_inteligencia_operativa?igsh=emJtamcyZWdmMW15" target="_blank" rel="noopener noreferrer" style="color:var(--text3);font-size:11px;text-decoration:none;display:flex;align-items:center;gap:4px">üì∏ Instagram</a>
      <a href="https://www.linkedin.com/company/GestiumInteligenciaOperativa" target="_blank" style="color:var(--text3);font-size:11px;text-decoration:none;display:flex;align-items:center;gap:4px">üíº LinkedIn</a>
    </div>
  </div>
  <div class="login-panel">
    <div class="login-logo-text">GESTIUM <span>¬∑</span></div>
    <div class="login-sub-text">Inteligencia Operativa ¬∑ B√°sico</div>
    <div style="margin-bottom:16px"><label class="f-label">Correo electr√≥nico</label><input id="loginEmail" type="email" class="f-input" placeholder="tu@empresa.com" autocomplete="username"></div>
    <div style="margin-bottom:10px"><label class="f-label">Contrase√±a</label>
      <div class="pw-wrap"><input id="loginPassword" type="password" class="f-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"><span id="togglePassword" class="pw-eye">üëÅ</span></div>
    </div>
    <div class="login-row">
      <label class="rem-label"><input id="remember" type="checkbox"> Recordarme</label>
      <button id="resetBtn" class="btn btn-ghost btn-sm" type="button">Recuperar</button>
    </div>
    <button id="loginBtn" class="btn btn-primary" type="button"><span id="loginText">Iniciar sesi√≥n</span><span id="loginSpinner" style="display:none">‚åõ</span></button>
    <p id="loginMessage" class="login-msg"></p>
    <div class="login-footer">¬øSin cuenta? <button id="showRegister" class="btn btn-ghost" style="display:inline;padding:0;margin-left:5px" type="button">Crear cuenta</button></div>
  </div>
</div>

<!-- REGISTRO -->
<div id="registerScreen">
  <div class="reg-card fade-up">
    <div class="reg-head"><h2>Crear cuenta</h2><p>Completa la informaci√≥n de tu empresa y usuario</p></div>
    <div class="reg-body">
      <div class="mode-tgl"><button class="mode-btn on" id="modeNuevaBtn" type="button">Nueva empresa</button><button class="mode-btn" id="modeExistenteBtn" type="button">Unirme a empresa</button></div>
      <input id="regModoEmpresa" type="hidden" value="nueva">
      <div id="bloqueEmpresaExistente" style="display:none"><div class="reg-sep">üè¢ ID de empresa</div><input id="regEmpresaExistente" class="ri" type="text" placeholder="ID de empresa"></div>
      <div id="bloqueNuevaEmpresa">
        <div class="reg-sep">üè¢ Datos de la empresa</div>
        <input id="regEmpresa" class="ri" type="text" placeholder="Nombre de la empresa *">
        <div class="reg-2"><input id="regNitEmpresa" class="ri" type="text" placeholder="NIT / RUT"><input id="regTelefonoEmpresa" class="ri" type="tel" placeholder="Tel√©fono empresa"></div>
        <input id="regDireccionEmpresa" class="ri" type="text" placeholder="Direcci√≥n">
        <div class="reg-2"><input id="regCiudadEmpresa" class="ri" type="text" placeholder="Ciudad"><input id="regPaisEmpresa" class="ri" type="text" placeholder="Pa√≠s" value="Colombia"></div>
        <input id="regWebEmpresa" class="ri" type="text" placeholder="Sitio web (opcional)">
        <input id="regEmailEmpresa" class="ri" type="email" placeholder="Email empresa">
      </div>
      <div class="reg-sep">üë§ Administrador</div>
      <div class="reg-2"><input id="regNombreUsuario" class="ri" type="text" placeholder="Nombre *"><input id="regApellidoUsuario" class="ri" type="text" placeholder="Apellido"></div>
      <input id="regCargoUsuario" class="ri" type="text" placeholder="Cargo">
      <div class="reg-2"><input id="regCelularUsuario" class="ri" type="tel" placeholder="Celular *"><input id="regTelefonoUsuario" class="ri" type="tel" placeholder="Tel√©fono fijo"></div>
      <div class="reg-sep">üîê Acceso</div>
      <input id="regEmail" class="ri" type="email" placeholder="Correo electr√≥nico *">
      <input id="regPassword" class="ri" type="password" placeholder="Contrase√±a (m√≠n. 6 caracteres) *">
      <button id="registerBtn" class="btn btn-primary" style="margin-top:8px" type="button">Crear Cuenta</button>
      <div style="text-align:center;margin-top:14px"><button id="backToLogin" class="btn btn-ghost" type="button">‚Üê Volver al login</button></div>
      <p id="registerMessage" class="reg-msg"></p>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <aside class="sidebar" id="sidebar">
    <div class="sb-stripe"></div>
    <div class="sb-top">
      <div class="sb-brand">Gestium ¬∑ B√°sico</div>
      <div class="sb-company" id="sidebarEmpresaNombre">‚Äî</div>
    </div>
    <nav class="sb-nav">
      <button class="sb-item" data-modulo="cotizaciones"><span class="sb-dot"></span>Cotizaciones</button>
      <button class="sb-item" data-modulo="dashboard"><span class="sb-dot"></span>Dashboard</button>
    </nav>
    <div class="sb-footer">
      <div class="user-pill">
        <div class="user-av" id="userAvatar">?</div>
        <div class="user-info"><div class="user-name" id="sidebarUserName">‚Äî</div><div class="user-email" id="sidebarUserEmail">‚Äî</div></div>
      </div>
      <button id="sidebarLogout" class="btn-logout">‚èª Cerrar sesi√≥n</button>
    </div>
  </aside>
  <div id="overlay" class="overlay"></div>
  <div class="main">
    <header class="topbar">
      <div style="display:flex;align-items:center;gap:12px">
        <button id="menuToggle">‚ò∞</button>
        <div class="topbar-title" id="topbarTitle">GESTIUM</div>
        <div class="live-dot" style="margin-left:4px"></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <span class="topbar-badge">B√ÅSICO</span>
        <button id="btnUploadLogo" class="btn btn-navy btn-sm" type="button">‚¨Ü Logo</button>
        <input type="file" id="logoInput" accept="image/*" style="display:none">
      </div>
    </header>

    <!-- COTIZACIONES -->
    <div id="moduloCotizaciones" class="page" style="display:none">
      <div class="sec-title">Cotizaciones <span class="sec-title-tag">GESTIUM</span></div>
      <div class="card" style="margin-bottom:18px"><div class="card-body">
        <div class="card-title">üë§ Clientes</div>
        <div style="display:grid;grid-template-columns:1fr auto;gap:10px;margin-bottom:14px;align-items:flex-end">
          <div><label class="f-lbl">Nuevo cliente</label><input id="cliente" class="inp" type="text" placeholder="Nombre del cliente"></div>
          <button id="guardarClienteBtn" class="btn btn-teal btn-sm" type="button">+ Guardar</button>
        </div>
        <div><label class="f-lbl">Seleccionar cliente</label><select id="listaClientes" class="inp"><option value="">-- Seleccionar --</option></select></div>
      </div></div>
      <div class="card" style="margin-bottom:18px"><div class="card-body">
        <div class="card-title">üìê Par√°metros</div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin-bottom:16px">
          <div><label class="f-lbl">Altura (cm)</label><input id="altura" class="inp" type="number" value="38"></div>
          <div><label class="f-lbl">Precio / m¬≥ (COP)</label><input id="precio" class="inp" type="number" value="235000"></div>
          <div><label class="f-lbl">IVA (%)</label><input id="iva" class="inp" type="number" value="19"></div>
        </div>
        <div style="margin-bottom:16px">
          <label class="f-lbl">Medidas (ej: 2-180*100 √≥ 3-200x100)</label>
          <textarea id="medidas" class="inp" style="min-height:110px;resize:vertical;font-family:'JetBrains Mono',monospace;font-size:13px" placeholder="2-180*100&#10;3-200x100"></textarea>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button id="generarBtn" class="btn btn-primary" type="button">üìÑ Generar Cotizaci√≥n PDF</button>
          <button id="generarReporteBtn" class="btn btn-teal btn-sm" type="button">üìä Reporte del Mes</button>
        </div>
      </div></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:18px">
        <button id="backupBtn" class="btn btn-sm btn-orange" type="button">üíæ Backup</button>
        <input id="restoreInput" type="file" accept=".json" style="display:none">
        <button id="restoreBtn" class="btn btn-sm btn-navy" type="button">üìÇ Restaurar</button>
      </div>
      <img id="logoPreview" class="logo-preview" style="display:none">
      <div class="card" style="margin-top:24px"><div class="card-body">
        <div class="card-title">üóÇ Cotizaciones Registradas</div>
        <div class="tbl-wrap">
          <table id="tablaCotizaciones">
            <thead><tr><th>N¬∞</th><th>Cliente</th><th>Fecha</th><th>Total</th><th>Estado</th><th>Acciones</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div></div>
    </div>

    <!-- DASHBOARD -->
    <div id="moduloDashboard" class="page" style="display:none">
      <div class="sec-title">Dashboard <span class="sec-title-tag">GESTIUM</span></div>
      <div class="filter-bar">
        <input id="mesReporte" type="month" class="inp" style="width:auto">
        <select id="clienteFiltro" class="inp" style="width:auto;min-width:180px"><option value="">‚Äî Todos los clientes ‚Äî</option></select>
        <button id="actualizarDashboard" class="btn btn-primary btn-sm" type="button">‚Ü∫ Actualizar</button>
        <button id="btnLimpiarFiltros" class="btn btn-sm btn-navy" type="button">‚úï Limpiar</button>
      </div>
      <div class="kpi-row">
        <div class="kpi k-teal"><div class="kpi-lbl">Total Cotizado</div><div class="kpi-val mono" id="kpiCotizado">‚Äî</div></div>
        <div class="kpi k-orange"><div class="kpi-lbl">Ventas Confirmadas</div><div class="kpi-val pos" id="kpiVentas">‚Äî</div></div>
        <div class="kpi k-amber"><div class="kpi-lbl">% Confirmaci√≥n</div><div class="kpi-val mono" id="kpiConversion">‚Äî</div></div>
        <div class="kpi k-gray"><div class="kpi-lbl">Cotizaciones</div><div class="kpi-val mono" id="kpiCantidad">‚Äî</div></div>
      </div>
      <div class="charts-grid">
        <div class="chart-box chart-box-full">
          <div class="chart-label"><span>‚óè</span> Ventas confirmadas por d√≠a</div>
          <div class="chart-container" style="height:280px"><canvas id="graficoVentas"></canvas></div>
        </div>
        <div class="chart-box">
          <div class="chart-label"><span>‚óè</span> Ventas por cliente</div>
          <div class="chart-container" style="height:270px"><canvas id="graficoClientes"></canvas></div>
        </div>
        <div class="chart-box">
          <div class="chart-label"><span>‚óè</span> Cotizaciones por estado</div>
          <div class="chart-container" style="height:270px"><canvas id="graficoEstados"></canvas></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail, setPersistence, browserLocalPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getFirestore, collection, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc, query, where, orderBy, Timestamp, runTransaction } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig={apiKey:"AIzaSyBF246-DxbLTyH-zXHlrSh92_Tq2JD7cfE",authDomain:"gestium-2d40b.firebaseapp.com",projectId:"gestium-2d40b",storageBucket:"gestium-2d40b.firebasestorage.app",messagingSenderId:"949260689854",appId:"1:949260689854:web:0b69f4e7d8ed0e9ac759ef"};
const app=initializeApp(firebaseConfig),auth=getAuth(app),db=getFirestore(app);
const P={teal:'#06d6c8',teal2:'#22d3ee',teal3:'#67e8f9',orange:'#f97316',orange2:'#fb923c',amber:'#f59e0b',red:'#ef4444',green:'#10b981',navy:'#0d1629',gray:'#64748b',gray2:'#94a3b8'};
const PALETTE=[P.teal,P.orange,P.amber,P.green,P.teal2,'#8b5cf6','#ec4899',P.gray2];

function addPdfWatermark(docPdf){
  const pw=docPdf.internal.pageSize.getWidth(),ph=docPdf.internal.pageSize.getHeight();
  try{ docPdf.saveGraphicsState(); docPdf.setGState(new docPdf.GState({opacity:0.04})); docPdf.setFont("helvetica","bold"); docPdf.setFontSize(48); docPdf.setTextColor(6,214,200); docPdf.text("GESTIUM",pw/2,ph/2,{align:"center",angle:45}); docPdf.restoreGraphicsState(); }catch(e){}
  docPdf.setFontSize(7); docPdf.setTextColor(150,150,150); docPdf.setFont("helvetica","normal");
  docPdf.text("GESTIUM ¬∑ Inteligencia Operativa",pw/2,ph-10,{align:"center"});
}

window.addEventListener('DOMContentLoaded',()=>{
  const $=id=>document.getElementById(id);
  const fmt=f=>{ const d=f instanceof Date?f:new Date(f); return d.toLocaleString("es-CO",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:false}); };
  const clp=n=>"$ "+Number(n).toLocaleString("es-CO");
  let empresaId=null,empresaData=null,usuarioData=null,logoB64=null;
  let chartV=null,chartC=null,chartE=null,ventasMes=[],cotizTotal=0,vendidoTotal=0,filtroCliente="",filtroEstado="";

  $("modeNuevaBtn").addEventListener("click",()=>{ $("regModoEmpresa").value="nueva"; $("modeNuevaBtn").classList.add("on"); $("modeExistenteBtn").classList.remove("on"); $("bloqueNuevaEmpresa").style.display="block"; $("bloqueEmpresaExistente").style.display="none"; });
  $("modeExistenteBtn").addEventListener("click",()=>{ $("regModoEmpresa").value="existente"; $("modeExistenteBtn").classList.add("on"); $("modeNuevaBtn").classList.remove("on"); $("bloqueNuevaEmpresa").style.display="none"; $("bloqueEmpresaExistente").style.display="block"; });
  $("showRegister").addEventListener("click",()=>{ $("loginScreen").style.display="none"; $("registerScreen").style.display="flex"; });
  $("backToLogin").addEventListener("click",()=>{ $("registerScreen").style.display="none"; $("loginScreen").style.display="flex"; });

  $("registerBtn").addEventListener("click", async()=>{
    const msg=$("registerMessage"); msg.textContent="";
    const modo=$("regModoEmpresa").value,nomEmp=$("regEmpresa").value.trim();
    const nitEmp=$("regNitEmpresa").value.trim(),telEmp=$("regTelefonoEmpresa").value.trim();
    const dirEmp=$("regDireccionEmpresa").value.trim(),ciudadEmp=$("regCiudadEmpresa").value.trim();
    const paisEmp=$("regPaisEmpresa").value.trim(),webEmp=$("regWebEmpresa").value.trim(),emailEmp=$("regEmailEmpresa").value.trim();
    const nomUser=$("regNombreUsuario").value.trim(),apUser=$("regApellidoUsuario").value.trim();
    const cargoUser=$("regCargoUsuario").value.trim(),celUser=$("regCelularUsuario").value.trim(),telUser=$("regTelefonoUsuario").value.trim();
    const email=$("regEmail").value.trim(),password=$("regPassword").value;
    const idExistente=$("regEmpresaExistente").value.trim();
    if(!nomUser||!celUser||!email||!password){ msg.textContent="Nombre, celular, correo y contrase√±a son obligatorios"; return; }
    if(password.length<6){ msg.textContent="Contrase√±a m√≠nimo 6 caracteres"; return; }
    if(modo==="nueva"&&!nomEmp){ msg.textContent="Escribe el nombre de la empresa"; return; }
    if(modo==="existente"&&!idExistente){ msg.textContent="Ingresa el ID de la empresa"; return; }
    try {
      const cred=await createUserWithEmailAndPassword(auth,email,password); const user=cred.user; let empId="";
      if(modo==="nueva"){
        const empRef=doc(collection(db,"empresas")); empId=empRef.id;
        const trial=new Date(); trial.setDate(trial.getDate()+7);
        await setDoc(empRef,{nombre:nomEmp,nit:nitEmp||"",telefono:telEmp||"",direccion:dirEmp||"",ciudad:ciudadEmp||"",pais:paisEmp||"Colombia",web:webEmp||"",email:emailEmp||email,plan:"trial",contador:0,vencimiento:Timestamp.fromDate(trial),logo:null,activa:true});
      } else {
        empId=idExistente;
        const s=await getDoc(doc(db,"empresas",empId)); if(!s.exists()){ msg.textContent="Empresa no encontrada"; return; }
      }
      await setDoc(doc(db,"Usuarios",user.uid),{email:user.email,nombre:nomUser,apellido:apUser||"",cargo:cargoUser||"",celular:celUser,telefono:telUser||"",empresaId:empId,rol:"admin",activo:true});
      alert("¬°Cuenta creada! Inicia sesi√≥n."); $("registerScreen").style.display="none"; $("loginScreen").style.display="flex";
    } catch(e){ msg.textContent=e.message||"Error creando cuenta"; }
  });

  $("togglePassword").addEventListener("click",()=>{ const p=$("loginPassword"); p.type=p.type==="password"?"text":"password"; $("togglePassword").textContent=p.type==="password"?"üëÅ":"üôà"; });
  function setLL(on){ $("loginBtn").disabled=on; $("loginText").style.display=on?"none":"inline"; $("loginSpinner").style.display=on?"inline":"none"; }
  function errV(){ ["loginEmail","loginPassword"].forEach(id=>$(id).classList.add("input-error")); $("loginBtn").classList.add("shake"); setTimeout(()=>$("loginBtn").classList.remove("shake"),350); const c=()=>{ ["loginEmail","loginPassword"].forEach(id=>$(id).classList.remove("input-error")); $("loginEmail").removeEventListener("input",c); $("loginPassword").removeEventListener("input",c); }; $("loginEmail").addEventListener("input",c); $("loginPassword").addEventListener("input",c); }
  $("loginBtn").addEventListener("click", async()=>{
    $("loginMessage").textContent=""; const e=$("loginEmail").value.trim(),p=$("loginPassword").value;
    if(!e||!p){ $("loginMessage").textContent="Ingresa correo y contrase√±a"; return; } setLL(true);
    try { await setPersistence(auth,$("remember").checked?browserLocalPersistence:browserSessionPersistence); await signInWithEmailAndPassword(auth,e,p); }
    catch(err){ const m={"auth/user-not-found":"El usuario no existe.","auth/wrong-password":"Contrase√±a incorrecta.","auth/invalid-email":"Correo no v√°lido.","auth/invalid-credential":"Correo o contrase√±a incorrectos.","auth/too-many-requests":"Demasiados intentos."}; $("loginMessage").textContent=m[err.code]||"Error al iniciar sesi√≥n."; errV(); setLL(false); }
  });
  $("resetBtn").addEventListener("click", async()=>{
    const e=$("loginEmail").value.trim(); if(!e){ $("loginMessage").textContent="Escribe tu correo"; return; }
    try { await sendPasswordResetEmail(auth,e); $("loginMessage").style.color=P.teal; $("loginMessage").textContent="Correo enviado ‚úì"; setTimeout(()=>{ $("loginMessage").textContent=""; $("loginMessage").style.color=""; },4000); }
    catch(err){ $("loginMessage").textContent=err.message; }
  });

  onAuthStateChanged(auth, async(user)=>{
    try {
      if(!user){ $("loginScreen").style.display="flex"; $("app").style.display="none"; setLL(false); return; }
      const uSnap=await getDoc(doc(db,"Usuarios",user.uid));
      if(!uSnap.exists()){ alert("Usuario no configurado."); await signOut(auth); return; }
      usuarioData=uSnap.data();
      if(!usuarioData.activo){ alert("Usuario desactivado."); await signOut(auth); return; }
      if(!usuarioData.empresaId){ alert("Sin empresa asignada."); await signOut(auth); return; }
      empresaId=usuarioData.empresaId;
      const eSnap=await getDoc(doc(db,"empresas",empresaId));
      if(!eSnap.exists()){ alert("Empresa no encontrada."); await signOut(auth); return; }
      empresaData=eSnap.data()||{};
      if(empresaData.vencimiento&&new Date()>empresaData.vencimiento.toDate()){ alert("Plan vencido."); await signOut(auth); return; }
      const nomEmp=empresaData.nombre||"Mi Empresa";
      $("sidebarEmpresaNombre").textContent=nomEmp; $("topbarTitle").textContent=nomEmp;
      const nombre=[usuarioData.nombre,usuarioData.apellido].filter(Boolean).join(" ")||"Usuario";
      $("sidebarUserName").textContent=nombre; $("sidebarUserEmail").textContent=user.email||"";
      $("userAvatar").textContent=(usuarioData.nombre||"?")[0].toUpperCase();
      logoB64=empresaData.logo||null;
      if(logoB64){ $("logoPreview").src=logoB64; $("logoPreview").style.display="block"; }
      await cargarClientes();
      $("loginScreen").style.display="none"; $("app").style.display="block";
      mostrarModulo("cotizaciones"); setLL(false);
    } catch(err){ setLL(false); alert("Error: "+(err.message||err)); try{await signOut(auth);}catch(e){} }
  });

  $("sidebarLogout").addEventListener("click", async()=>{
    await signOut(auth); empresaId=null; empresaData=null; usuarioData=null; logoB64=null;
    [chartV,chartC,chartE].forEach(c=>{if(c)c.destroy();}); chartV=chartC=chartE=null;
  });

  const sidebar=$("sidebar"),overlay=$("overlay");
  $("menuToggle").addEventListener("click",()=>{ sidebar.classList.toggle("open"); overlay.classList.toggle("on"); });
  overlay.addEventListener("click",()=>{ sidebar.classList.remove("open"); overlay.classList.remove("on"); });

  window.mostrarModulo=function(n){
    ["moduloCotizaciones","moduloDashboard"].forEach(id=>$(id).style.display="none");
    if(n==="cotizaciones"){ $("moduloCotizaciones").style.display="block"; cargarTablaCotizaciones(); }
    if(n==="dashboard"){ $("moduloDashboard").style.display="block"; actualizarDashboard(); }
  };
  document.querySelectorAll(".sb-item[data-modulo]").forEach(b=>{
    b.addEventListener("click",()=>{ document.querySelectorAll(".sb-item").forEach(x=>x.classList.remove("active")); b.classList.add("active"); mostrarModulo(b.dataset.modulo); sidebar.classList.remove("open"); overlay.classList.remove("on"); });
  });

  async function cargarClientes(){
    if(!empresaId) return;
    ["listaClientes","clienteFiltro"].forEach(id=>{ const s=$(id); if(!s) return; s.innerHTML='<option value="">-- Seleccionar --</option>'; });
    const snap=await getDocs(query(collection(db,"empresas",empresaId,"clientes"),orderBy("creadoEn","desc")));
    snap.forEach(d=>{ const n=d.data().nombre||d.id||"Sin nombre"; const o=document.createElement("option"); o.value=n; o.textContent=n; ["listaClientes","clienteFiltro"].forEach(id=>{ const s=$(id); if(s) s.appendChild(o.cloneNode(true)); }); });
  }
  $("guardarClienteBtn").addEventListener("click", async()=>{
    const n=$("cliente").value.trim(); if(!n){ alert("Escribe un cliente"); return; }
    const col=collection(db,"empresas",empresaId,"clientes"); const snap=await getDocs(col); let existe=false;
    snap.forEach(d=>{ if((d.data().nombre||"").toLowerCase()===n.toLowerCase()) existe=true; });
    if(existe){ alert("Ese cliente ya existe."); return; }
    await addDoc(col,{nombre:n,nombreNormalizado:n.toLowerCase(),creadoEn:Timestamp.fromDate(new Date())});
    await cargarClientes(); $("cliente").value=""; alert("Cliente guardado ‚úì");
  });
  $("listaClientes").addEventListener("change",()=>{ $("cliente").value=$("listaClientes").value; });
  $("clienteFiltro").addEventListener("change",()=>{ filtroCliente=($("clienteFiltro").value||"").trim(); actualizarDashboard(); });
  $("btnLimpiarFiltros").addEventListener("click",()=>{ filtroCliente=""; $("clienteFiltro").value=""; actualizarDashboard(); });

  function pdfHeader(docPdf,numero,label){
    const pw=docPdf.internal.pageSize.getWidth(),emp=empresaData||{},H=96;
    docPdf.setFillColor(7,13,26); docPdf.rect(0,0,pw,H,"F");
    docPdf.setFillColor(6,214,200); docPdf.rect(0,0,pw,3,"F");
    docPdf.setFillColor(249,115,22); docPdf.rect(0,H-3,pw,3,"F");
    if(logoB64){ try{ const t=logoB64.startsWith("data:image/png")?"PNG":"JPEG"; docPdf.addImage(logoB64,t,34,12,80,44); }catch(e){} }
    docPdf.setTextColor(255,255,255); docPdf.setFont("helvetica","bold"); docPdf.setFontSize(16);
    docPdf.text(emp.nombre||"Mi Empresa",pw-34,26,{align:"right"});
    docPdf.setFont("helvetica","normal"); docPdf.setFontSize(8); let yd=38;
    if(emp.nit){ docPdf.text("NIT: "+emp.nit,pw-34,yd,{align:"right"}); yd+=10; }
    const dir=[emp.direccion,emp.ciudad,emp.pais].filter(Boolean).join(", ");
    if(dir){ docPdf.text(dir,pw-34,yd,{align:"right"}); yd+=10; }
    if(emp.telefono){ docPdf.text("Tel: "+emp.telefono,pw-34,yd,{align:"right"}); yd+=10; }
    if(emp.web){ docPdf.text(emp.web,pw-34,yd,{align:"right"}); yd+=10; }
    if(emp.email){ docPdf.text(emp.email,pw-34,yd,{align:"right"}); }
    docPdf.setFillColor(249,115,22); docPdf.rect(34,H+10,6,30,"F");
    docPdf.setTextColor(249,115,22); docPdf.setFont("helvetica","bold"); docPdf.setFontSize(13);
    docPdf.text(label+": "+numero,44,H+22);
    docPdf.setFont("helvetica","normal"); docPdf.setFontSize(9); docPdf.setTextColor(80,80,80);
    docPdf.text("Fecha: "+fmt(new Date()),44,H+34);
    const asesor=[usuarioData?.nombre,usuarioData?.apellido].filter(Boolean).join(" ");
    if(asesor||usuarioData?.celular){ let ya=H+46; if(asesor){ docPdf.text("Asesor: "+asesor+(usuarioData?.cargo?" ¬∑ "+usuarioData.cargo:""),44,ya); ya+=12; } if(usuarioData?.celular){ docPdf.text("Cel: "+usuarioData.celular,44,ya); } }
    addPdfWatermark(docPdf);
    return H+75;
  }
  function attachAT(d){ if(d.autoTable) return; try{ const a=window.jspdf?.jsPDF?.API?.autoTable; if(a) d.autoTable=(...x)=>a.call(d,...x); }catch(e){} }

  $("generarBtn").addEventListener("click", async()=>{
    if(!empresaId) return alert("Sin empresa activa");
    const cliente=$("cliente").value.trim()||"Cliente";
    const altura=parseFloat($("altura").value)||0,precio=parseFloat($("precio").value)||0;
    const ivaP=parseFloat($("iva").value)||0,texto=$("medidas").value.trim();
    if(!texto) return alert("Ingresa medidas"); if(altura<=0||precio<=0) return alert("Altura y precio > 0");
    let filas=[],subtotal=0,totalM3=0;
    texto.split("\n").forEach(raw=>{
      let l=raw.trim().replace(/\s+/g,""); if(!l) return;
      let cant=1; if(l.includes("-")){ const p=l.split("-"); cant=parseInt(p[0])||1; l=p[1]; }
      l=l.toUpperCase(); const pts=l.includes("*")?l.split("*"):l.split("X"); const a=parseFloat(pts[0]),b=parseFloat(pts[1]); if(!a||!b) return;
      const m3=(a/100)*(b/100)*(altura/100)*cant,tl=m3*precio; subtotal+=tl; totalM3+=m3;
      filas.push([cant,a,b,altura,m3.toFixed(3),clp(tl)]);
    });
    const ivaT=subtotal*(ivaP/100),total=subtotal+ivaT;
    const empRef=doc(db,"empresas",empresaId); let num="";
    try {
      await runTransaction(db,async(tx)=>{
        const es=await tx.get(empRef); if(!es.exists()) throw "Empresa no encontrada";
        const cnt=(es.data().contador||0)+1; num="COT-"+String(cnt).padStart(3,"0");
        tx.update(empRef,{contador:cnt});
        tx.set(doc(collection(db,"empresas",empresaId,"cotizaciones")),{numero:num,cliente,fecha:Timestamp.fromDate(new Date()),subtotal,iva:ivaT,total,m3:totalM3,estado:"Pendiente",medidasTexto:texto,altura,precio,ivaPorcentaje:ivaP});
      });
    } catch(e){ alert("Error: "+e); return; }
    const {jsPDF}=window.jspdf;
    const docPdf=new jsPDF({unit:"pt",format:"a4"}); const pw=docPdf.internal.pageSize.getWidth();
    attachAT(docPdf);
    const sy=pdfHeader(docPdf,num,"Cotizaci√≥n");
    docPdf.setFont("helvetica","bold"); docPdf.setFontSize(10); docPdf.setTextColor(40);
    docPdf.text("Para:",38,sy); docPdf.setFont("helvetica","normal"); docPdf.setTextColor(249,115,22); docPdf.text(cliente,76,sy);
    try{ docPdf.autoTable({startY:sy+14,head:[["Cant","Ancho cm","Largo cm","Altura cm","m¬≥","Total"]],body:filas,theme:"grid",headStyles:{fillColor:[7,13,26],textColor:[6,214,200],fontStyle:"bold",fontSize:9},alternateRowStyles:{fillColor:[248,250,252]},styles:{halign:"center",cellPadding:8,fontSize:10},margin:{left:38,right:38}}); }catch(e){}
    const fy=docPdf.lastAutoTable?docPdf.lastAutoTable.finalY+18:270;
    docPdf.setDrawColor(6,214,200); docPdf.setLineWidth(.5); docPdf.line(38,fy,pw-38,fy);
    docPdf.setFontSize(10); docPdf.setTextColor(80,80,80); docPdf.setFont("helvetica","normal");
    docPdf.text("Subtotal:",pw-200,fy+16); docPdf.text(clp(subtotal),pw-38,fy+16,{align:"right"});
    docPdf.text("IVA ("+ivaP+"%):",pw-200,fy+30); docPdf.text(clp(ivaT),pw-38,fy+30,{align:"right"});
    docPdf.setFillColor(7,13,26); docPdf.roundedRect(pw-210,fy+38,172,24,4,4,"F");
    docPdf.setFont("helvetica","bold"); docPdf.setFontSize(13); docPdf.setTextColor(6,214,200);
    docPdf.text("TOTAL: "+clp(total),pw-44,fy+54,{align:"right"});
    docPdf.setFont("helvetica","normal"); docPdf.setFontSize(9.5); docPdf.setTextColor(130);
    docPdf.text("Gracias por confiar en "+(empresaData.nombre||"nosotros")+".",38,fy+76);
    if(empresaData.telefono) docPdf.text("Contacto: "+empresaData.telefono,38,fy+88);
    docPdf.save(num+" - "+cliente.replace(/\s+/g,"_")+".pdf");
    cargarTablaCotizaciones(); actualizarDashboard(); alert("Cotizaci√≥n generada: "+num+" ‚úì");
  });

  window.redescargarCotizacion=async function(id){
    const snap=await getDoc(doc(db,"empresas",empresaId,"cotizaciones",id));
    if(!snap.exists()){ alert("No encontrada"); return; }
    const d=snap.data(); if(!d.medidasTexto){ alert("Datos incompletos"); return; }
    const {jsPDF}=window.jspdf;
    const docPdf=new jsPDF({unit:"pt",format:"a4"}); const pw=docPdf.internal.pageSize.getWidth();
    attachAT(docPdf);
    const sy=pdfHeader(docPdf,d.numero,"Cotizaci√≥n");
    docPdf.setFont("helvetica","bold"); docPdf.setFontSize(10); docPdf.setTextColor(40);
    docPdf.text("Para:",38,sy); docPdf.setFont("helvetica","normal"); docPdf.setTextColor(249,115,22); docPdf.text(d.cliente,76,sy);
    let filas=[];
    d.medidasTexto.split("\n").forEach(raw=>{
      let l=raw.trim().replace(/\s+/g,""); if(!l) return;
      let cant=1; if(l.includes("-")){ const p=l.split("-"); cant=parseInt(p[0])||1; l=p[1]; }
      l=l.toUpperCase(); const pts=l.includes("*")?l.split("*"):l.split("X"); const a=parseFloat(pts[0]),b=parseFloat(pts[1]);
      const m3=(a/100)*(b/100)*(d.altura/100)*cant; filas.push([cant,a,b,d.altura,m3.toFixed(3),clp(m3*d.precio)]);
    });
    try{ docPdf.autoTable({startY:sy+14,head:[["Cant","Ancho cm","Largo cm","Altura cm","m¬≥","Total"]],body:filas,theme:"grid",headStyles:{fillColor:[7,13,26],textColor:[6,214,200],fontStyle:"bold",fontSize:9},styles:{halign:"center",cellPadding:8,fontSize:10},margin:{left:38,right:38}}); }catch(e){}
    const fy=docPdf.lastAutoTable?docPdf.lastAutoTable.finalY+18:270;
    docPdf.setFillColor(7,13,26); docPdf.roundedRect(pw-210,fy+10,172,24,4,4,"F");
    docPdf.setFont("helvetica","bold"); docPdf.setFontSize(13); docPdf.setTextColor(6,214,200);
    docPdf.text("TOTAL: "+clp(d.total),pw-44,fy+26,{align:"right"});
    docPdf.save(d.numero+".pdf");
  };

  window.manejarAccion=async function(id,accion){
    if(!accion) return;
    const ref=doc(db,"empresas",empresaId,"cotizaciones",id);
    if(accion==="Confirmar"){ const s=await getDoc(ref); if(!s.exists()) return; const d=s.data(); if(d.estado==="Convertida") return; await updateDoc(ref,{estado:"Convertida"}); }
    else if(accion==="Pendiente"){ await updateDoc(ref,{estado:"Pendiente"}); }
    else if(accion==="Eliminar"){ if(!confirm("¬øEliminar cotizaci√≥n? Se ocultar√° del sistema.")) return; await updateDoc(ref,{estado:"Cancelada"}); }
    cargarTablaCotizaciones(); actualizarDashboard();
  };

  async function cargarTablaCotizaciones(){
    if(!empresaId) return;
    const snap=await getDocs(query(collection(db,"empresas",empresaId,"cotizaciones"),where("estado","!=","Cancelada"),orderBy("estado"),orderBy("fecha","desc")));
    const tbody=document.querySelector("#tablaCotizaciones tbody"); tbody.innerHTML="";
    snap.forEach(ds=>{
      const d=ds.data(); if(!d.fecha) return; const f=d.fecha.toDate();
      const badge=d.estado==="Convertida"?'<span class="badge badge-teal">Confirmada</span>':d.estado==="Pendiente"?'<span class="badge badge-amber">Pendiente</span>':'<span class="badge badge-gray">'+d.estado+'</span>';
      tbody.innerHTML+=`<tr>
        <td class="mono" style="color:var(--teal)">${d.numero||"-"}</td>
        <td>${d.cliente||"-"}</td>
        <td style="font-size:11px;color:var(--text2)">${fmt(f)}</td>
        <td class="mono">${clp(d.total||0)}</td>
        <td>${badge}</td>
        <td style="display:flex;gap:8px;align-items:center">
          <button onclick="window.redescargarCotizacion('${ds.id}')" style="background:rgba(6,214,200,.1);border:1px solid rgba(6,214,200,.2);border-radius:6px;cursor:pointer;font-size:13px;padding:4px 8px;color:var(--teal)" title="Descargar PDF">üì•</button>
          <select class="estado-sel" onchange="window.manejarAccion('${ds.id}',this.value)" ${d.estado==="Convertida"?"disabled":""}>
            <option value="">Seleccionar</option>
            <option value="Confirmar">‚úì Confirmar venta</option>
            <option value="Pendiente">‚è≥ Pendiente</option>
            <option value="Eliminar">‚úï Eliminar</option>
          </select>
        </td>
      </tr>`;
    });
  }

  $("generarReporteBtn").addEventListener("click", async()=>{
    if(!empresaId) return alert("Sin empresa activa");
    const mv=$("mesReporte").value; if(!mv) return alert("Selecciona mes en el Dashboard");
    const [anio,mes]=mv.split("-");
    const snap=await getDocs(query(collection(db,"empresas",empresaId,"cotizaciones"),orderBy("fecha","desc")));
    let filas=[],total=0,totalM3=0;
    snap.forEach(d=>{ const v=d.data(); if(!v?.fecha) return; const f=v.fecha.toDate(); if(f.getFullYear()==parseInt(anio)&&(f.getMonth()+1)==parseInt(mes)&&v.estado==="Convertida"){ filas.push([v.numero||"-",v.cliente||"-",fmt(f),(v.m3||0).toFixed(3),clp(v.total||0)]); total+=Number(v.total||0); totalM3+=Number(v.m3||0); } });
    if(!filas.length) return alert("No hay ventas confirmadas en ese per√≠odo.");
    const {jsPDF}=window.jspdf; const docPdf=new jsPDF(); const pw=docPdf.internal.pageSize.getWidth();
    attachAT(docPdf);
    docPdf.setFillColor(7,13,26); docPdf.rect(0,0,pw,36,"F");
    docPdf.setFillColor(6,214,200); docPdf.rect(0,0,pw,3,"F");
    if(logoB64){ try{ const t=logoB64.startsWith("data:image/png")?"PNG":"JPEG"; docPdf.addImage(logoB64,t,10,5,44,26); }catch(e){} }
    docPdf.setTextColor(255,255,255); docPdf.setFont("helvetica","bold"); docPdf.setFontSize(14);
    docPdf.text("REPORTE MENSUAL DE VENTAS",pw/2,16,{align:"center"}); docPdf.setFont("helvetica","normal"); docPdf.setFontSize(9);
    docPdf.text(empresaData.nombre||"",pw/2,26,{align:"center"});
    docPdf.setFillColor(249,115,22); docPdf.rect(0,33,pw,3,"F");
    addPdfWatermark(docPdf);
    let y=46; const emp=empresaData||{};
    if(emp.nit){ docPdf.setTextColor(40); docPdf.text("NIT: "+emp.nit,14,y); y+=9; }
    docPdf.setFont("helvetica","bold"); docPdf.setTextColor(249,115,22);
    docPdf.text("Per√≠odo: "+mv,14,y); y+=9;
    docPdf.setFont("helvetica","normal"); docPdf.setTextColor(80,80,80);
    docPdf.text("Generado: "+fmt(new Date()),14,y); y+=14;
    try{ docPdf.autoTable({startY:y,head:[["N¬∞","Cliente","Fecha","m¬≥","Total"]],body:filas,theme:"grid",headStyles:{fillColor:[7,13,26],textColor:[6,214,200],fontSize:9},alternateRowStyles:{fillColor:[248,250,252]},styles:{fontSize:9}}); }catch(e){}
    const yf=docPdf.lastAutoTable?docPdf.lastAutoTable.finalY+16:100;
    docPdf.setFont("helvetica","bold"); docPdf.setFontSize(11); docPdf.setTextColor(7,13,26);
    docPdf.text("Total m¬≥: "+totalM3.toFixed(3),14,yf+14);
    docPdf.setTextColor(249,115,22); docPdf.text("Total Ventas: "+clp(total),14,yf+28);
    docPdf.save("ReporteVentas_"+mv+".pdf");
  });

  $("actualizarDashboard").addEventListener("click",actualizarDashboard);
  $("moduloDashboard")?.addEventListener("dblclick",(evt)=>{
    if(evt.target.closest("canvas")) return;
    if(filtroCliente||filtroEstado){
      filtroCliente=""; filtroEstado="";
      document.querySelectorAll(".filtro-on").forEach(el=>el.classList.remove("filtro-on"));
      actualizarDashboard();
    }
  });
  async function actualizarDashboard(){
    if(!empresaId) return;
    document.body.style.cursor="wait";
    const mesI=$("mesReporte");
    if(!mesI.value){ const h=new Date(); mesI.value=`${h.getFullYear()}-${String(h.getMonth()+1).padStart(2,"0")}`; }
    const anio=Number(mesI.value.substring(0,4)),mes=Number(mesI.value.substring(5,7))-1;
    // ‚úÖ FIX: Filtrar por fecha en query, no cargar todo en memoria
    const inicioMes=new Date(anio,mes,1),finMes=new Date(anio,mes+1,0,23,59,59);
    const snap=await getDocs(query(collection(db,"empresas",empresaId,"cotizaciones"),
      where("fecha",">=",Timestamp.fromDate(inicioMes)),
      where("fecha","<=",Timestamp.fromDate(finMes)),
      orderBy("fecha","desc")));
    const docs=[]; snap.forEach(d=>docs.push({id:d.id,...d.data()}));
    cotizTotal=0; vendidoTotal=0; ventasMes=[]; let cant=0, cantConf=0;
    const estCount={};
    docs.forEach(v=>{
      if(!v?.fecha) return;
      if(v.estado==="Cancelada") return;
      const e=v.estado||"Pendiente"; estCount[e]=(estCount[e]||0)+1;
      if(filtroCliente&&String(v.cliente||"").trim().toLowerCase()!==filtroCliente.toLowerCase()) return;
      if(filtroEstado&&(v.estado||"Pendiente")!==filtroEstado) return;
      cotizTotal+=Number(v.total||0); cant++;
      if(v.estado==="Convertida"){ vendidoTotal+=Number(v.total||0); ventasMes.push(v); cantConf++; }
    });
    $("kpiCotizado").textContent=clp(cotizTotal);
    $("kpiVentas").textContent=clp(vendidoTotal);
    $("kpiConversion").textContent=(cant>0?(cantConf/cant*100).toFixed(1):0)+"%";
    $("kpiCantidad").textContent=cant;

    if(!ventasMes.length){ [chartV,chartC,chartE].forEach(c=>{if(c)c.destroy();}); chartV=chartC=chartE=null; renderEstados(estCount); document.body.style.cursor="default"; return; }

    const vpd={},vpc={};
    ventasMes.forEach(v=>{ const f=v.fecha.toDate?v.fecha.toDate():new Date(v.fecha); const dia=f.getDate(); vpd[dia]=(vpd[dia]||0)+Number(v.total||0); vpc[v.cliente||"Sin cliente"]=(vpc[v.cliente||"Sin cliente"]||0)+Number(v.total||0); });
    const dias=Object.keys(vpd).map(Number).sort((a,b)=>a-b);

    if(chartV) chartV.destroy();
    const canvasV=$("graficoVentas"); canvasV.style.height="280px";
    chartV=new Chart(canvasV.getContext("2d"),{
      type:"bar",
      data:{labels:dias.map(d=>"D"+d),datasets:[{label:"Ventas",data:dias.map(d=>vpd[d]),backgroundColor:dias.map((_,i)=>i%2===0?P.teal:P.orange),borderRadius:{topLeft:6,topRight:6},borderSkipped:false,barPercentage:.6,categoryPercentage:.7,borderWidth:0,hoverBackgroundColor:P.teal3}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{backgroundColor:P.navy,titleColor:P.teal,bodyColor:"#e2e8f0",padding:12,displayColors:false,callbacks:{title:c=>"D√≠a "+c[0].label.replace("D",""),label:c=>"Ventas: "+clp(c.raw)}}},scales:{x:{grid:{display:false},ticks:{font:{size:10,family:"Syne",weight:"700"},color:P.gray2},border:{display:false}},y:{beginAtZero:true,grid:{color:"rgba(255,255,255,.04)"},ticks:{font:{size:10,family:"JetBrains Mono"},color:P.gray2,callback:v=>"$"+Number(v/1000000).toFixed(1)+"M"},border:{display:false}}},animation:{duration:700,easing:"easeOutQuart"}}
    });

    const clsCli=Object.keys(vpc);
    if(chartC) chartC.destroy();
    if(clsCli.length){
      const canvasC=$("graficoClientes"); canvasC.style.height="270px";
      chartC=new Chart(canvasC,{
        type:"doughnut",
        data:{labels:clsCli,datasets:[{data:clsCli.map(c=>vpc[c]),backgroundColor:PALETTE,borderColor:P.navy,borderWidth:3,hoverOffset:14}]},
        options:{responsive:true,maintainAspectRatio:false,cutout:"70%",plugins:{legend:{position:"right",labels:{boxWidth:10,padding:12,font:{size:11,family:"Syne",weight:"700"},color:"#e2e8f0",generateLabels:chart=>{return chart.data.labels.map((l,i)=>{const v=chart.data.datasets[0].data[i];return{text:l+": "+clp(v),fillStyle:chart.data.datasets[0].backgroundColor[i],strokeStyle:chart.data.datasets[0].backgroundColor[i],lineWidth:0,hidden:false,index:i};});}}},tooltip:{backgroundColor:P.navy,titleColor:P.teal,bodyColor:"#e2e8f0",padding:12,callbacks:{label:c=>`${c.label}: ${clp(c.raw)}`}}},animation:{animateScale:true,duration:900},onClick:(evt)=>{ const pts=chartC.getElementsAtEventForMode(evt,"nearest",{intersect:true},true); if(pts.length){filtroCliente=(filtroCliente===clsCli[pts[0].index]?"":clsCli[pts[0].index]);}else{filtroCliente="";} filtroEstado=""; $("graficoClientes")?.parentElement?.parentElement?.classList.toggle("filtro-on",!!filtroCliente); $("graficoEstados")?.parentElement?.parentElement?.classList.remove("filtro-on"); actualizarDashboard(); }}
      });
    }
    renderEstados(estCount);
    document.body.style.cursor="default";
  }

  function renderEstados(estCount){
    const estL=Object.keys(estCount),estC={"Convertida":P.teal,"Pendiente":P.gray,"En espera":P.amber,"Cancelada":P.red};
    if(chartE) chartE.destroy();
    if(estL.length){
      const canvasE=$("graficoEstados"); canvasE.style.height="270px";
      chartE=new Chart(canvasE,{type:"doughnut",data:{labels:estL,datasets:[{data:estL.map(e=>estCount[e]),backgroundColor:estL.map(e=>estC[e]||P.gray2),borderColor:P.navy,borderWidth:3,hoverOffset:10}]},options:{responsive:true,maintainAspectRatio:false,cutout:"65%",plugins:{legend:{position:"right",labels:{boxWidth:10,padding:12,font:{size:11,family:"Syne",weight:"700"},color:"#e2e8f0",generateLabels:chart=>{return chart.data.labels.map((l,i)=>{const v=chart.data.datasets[0].data[i];return{text:l+": "+v,fillStyle:chart.data.datasets[0].backgroundColor[i],strokeStyle:chart.data.datasets[0].backgroundColor[i],lineWidth:0,hidden:false,index:i};});}}},tooltip:{backgroundColor:P.navy,titleColor:P.orange,bodyColor:"#e2e8f0",padding:12,callbacks:{label:c=>`${c.label}: ${c.raw} cotizaciones`}}},animation:{animateScale:true,duration:800},onClick:(evt)=>{const pts=chartE.getElementsAtEventForMode(evt,"nearest",{intersect:true},true);if(pts.length){const lbl=estL[pts[0].index];filtroEstado=(filtroEstado===lbl?"":lbl);$("graficoEstados")?.parentElement?.parentElement?.classList.toggle("filtro-on",!!filtroEstado);$("graficoClientes")?.parentElement?.parentElement?.classList.remove("filtro-on");filtroCliente="";actualizarDashboard();}}}});
    }
  }

  $("btnUploadLogo").addEventListener("click",()=>$("logoInput").click());
  $("logoInput").addEventListener("change", async(evt)=>{ const f=evt.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=async()=>{ try{ logoB64=r.result; await updateDoc(doc(db,"empresas",empresaId),{logo:logoB64}); $("logoPreview").src=logoB64; $("logoPreview").style.display="block"; empresaData.logo=logoB64; }catch(e){ alert("Error: "+e.message); } }; r.readAsDataURL(f); });

  $("backupBtn").addEventListener("click", async()=>{
    if(!empresaId) return;
    const cS=await getDocs(collection(db,"empresas",empresaId,"clientes")); const vS=await getDocs(collection(db,"empresas",empresaId,"cotizaciones"));
    const data={clientes:cS.docs.map(d=>({id:d.id,...d.data()})),cotizaciones:vS.docs.map(d=>({id:d.id,...d.data()})),empresa:empresaData};
    const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"}),url=URL.createObjectURL(blob),a=document.createElement("a");
    a.href=url; a.download=`gestium_backup_${empresaId}_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(url);
  });
  $("restoreBtn").addEventListener("click",()=>$("restoreInput").click());
  $("restoreInput").addEventListener("change", async(evt)=>{ const f=evt.target.files[0]; if(!f) return; try{ JSON.parse(await f.text()); alert("Backup verificado ‚úì"); }catch(e){ alert("Error: "+e.message); } });
});
</script>
</body>
</html>
